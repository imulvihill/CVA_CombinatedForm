<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA Coffee Cupping App</title>
    <!-- Incluimos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Dependencias para PDF y Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb"> 

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Evita el "rebote" del scroll en iOS */
            overscroll-behavior: none;
        }
        /* Estilo para los "tags" de aromas seleccionados */
        .aroma-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            margin: 4px;
            border-radius: 16px;
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            max-width: 100%; 
        }
        .aroma-tag-text {
            flex-grow: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }
        .aroma-tag button {
            margin-left: 8px;
            font-weight: bold;
            opacity: 0.7;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen">

    <!-- Cabecera de la App (Fija) -->
    <header class="p-4 bg-blue-800 text-white shadow-md">
        <h1 class="text-xl font-bold text-center">SCA Coffee Value Assessment</h1>
    </header>

    <!-- Barra de Progreso (Fija) -->
    <div class="w-full bg-gray-200">
        <div id="progressBar" class="bg-blue-600 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-r-full" style="width: 0%">
            <span id="progressText">Paso 0 de 8</span>
        </div>
    </div>

    <!-- Contenedor principal de Pasos (con scroll) -->
    <!-- Este div contendrá el formulario completo para la exportación a PDF -->
    <div id="cuppingSheetContainer" class="flex-1 overflow-y-auto">
        <main class="p-4 space-y-6">

            <!-- PASO 0: Metadatos -->
            <div id="step-0" class="step-content space-y-4">
                <h2 class="text-2xl font-semibold text-gray-700">Información de la Cata</h2>
                <div class="space-y-4 p-4 bg-white rounded-lg shadow">
                    <div>
                        <label for="catador_nombre" class="block text-sm font-medium text-gray-700">Nombre (Catador):</label>
                        <input type="text" id="catador_nombre" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Tu nombre...">
                    </div>
                    <div>
                        <label for="catador_fecha" class="block text-sm font-medium text-gray-700">Fecha:</label>
                        <input type="date" id="catador_fecha" class="w-full mt-1 p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="catador_cafe" class="block text-sm font-medium text-gray-700">Café (Muestra):</label>
                        <input type="text" id="catador_cafe" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="ID de la muestra...">
                    </div>
                </div>
            </div>

            <!-- PASO 1: Fragrance & Aroma -->
            <div id="step-1" class="step-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Paso 1: Fragancia y Aroma</h2>
                <!-- Parte Descriptiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-white shadow">
                    <h3 class="text-lg font-bold">Descriptivo</h3>
                    <div class="space-y-2">
                        <label for="fragrance_intensity" class="flex justify-between items-center text-md font-medium">
                            <span>Fragrance Intensity</span>
                            <span id="fragrance_intensity_val" class="font-bold text-blue-600">7</span>
                        </label>
                        <input type="range" id="fragrance_intensity" name="fragrance_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('fragrance_intensity')">
                    </div>
                    <div class="space-y-2">
                        <label for="aroma_intensity" class="flex justify-between items-center text-md font-medium">
                            <span>Aroma Intensity</span>
                            <span id="aroma_intensity_val" class="font-bold text-blue-600">7</span>
                        </label>
                        <input type="range" id="aroma_intensity" name="aroma_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('aroma_intensity')">
                    </div>
                    <div class="space-y-3">
                        <h4 class="text-md font-medium">Select up to five that apply:</h4>
                        <div id="fragrance_aroma_tags" class="flex flex-wrap -m-1"></div>
                        <div id="fragrance_aroma_grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <!-- Botones generados por JS -->
                        </div>
                    </div>
                </section>
                <!-- Parte Afectiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-gray-50 shadow">
                    <h3 class="text-lg font-bold">Afectivo (Puntuación)</h3>
                    <div class="space-y-2">
                        <label for="fragrance_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Fragrance (Final)</span>
                            <span id="fragrance_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="fragrance_final" name="fragrance_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('fragrance_final')">
                    </div>
                    <div class="space-y-2">
                        <label for="aroma_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Aroma (Final)</span>
                            <span id="aroma_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="aroma_final" name="aroma_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('aroma_final')">
                    </div>
                    <div class="space-y-2 mt-4">
                        <label for="fragrance_aroma_final_notes" class="text-md font-medium text-gray-700">Notes (optional):</label>
                        <textarea id="fragrance_aroma_final_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-24" placeholder="Notes for final score..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
            </div>

            <!-- PASO 2: Flavor & Aftertaste -->
            <div id="step-2" class="step-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Paso 2: Sabor y Postgusto</h2>
                <!-- Parte Descriptiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-white shadow">
                    <h3 class="text-lg font-bold">Descriptivo</h3>
                    <div class="space-y-2">
                        <label for="flavor_intensity" class="flex justify-between items-center text-md font-medium">
                            <span>Flavor Intensity</span>
                            <span id="flavor_intensity_val" class="font-bold text-blue-600">7</span>
                        </label>
                        <input type="range" id="flavor_intensity" name="flavor_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('flavor_intensity')">
                    </div>
                    <div class="space-y-2">
                        <label for="aftertaste_intensity" class="flex justify-between items-center text-md font-medium">
                            <span>Aftertaste Intensity</span>
                            <span id="aftertaste_intensity_val" class="font-bold text-blue-600">7</span>
                        </label>
                        <input type="range" id="aftertaste_intensity" name="aftertaste_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('aftertaste_intensity')">
                    </div>
                    <div class="space-y-3">
                        <h4 class="text-md font-medium">Select up to five that apply:</h4>
                        <div id="flavor_aroma_tags" class="flex flex-wrap -m-1"></div>
                        <div id="flavor_aroma_grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <!-- Botones generados por JS -->
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h4 class="text-md font-medium">Main Tastes (select up to 2)</h4>
                        <div class="flex flex-wrap gap-x-4 gap-y-2">
                            <label class="flex items-center gap-2"><input type="checkbox" name="main_taste" value="salty" class="form-checkbox h-5 w-5"> Salty</label>
                            <label class="flex items-center gap-2"><input type="checkbox" name="main_taste" value="sour" class="form-checkbox h-5 w-5"> Sour</label>
                            <label class="flex items-center gap-2"><input type="checkbox" name="main_taste" value="sweet" class="form-checkbox h-5 w-5"> Sweet</label>
                            <label class="flex items-center gap-2"><input type="checkbox" name="main_taste" value="bitter" class="form-checkbox h-5 w-5"> Bitter</label>
                            <label class="flex items-center gap-2"><input type="checkbox" name="main_taste" value="umami" class="form-checkbox h-5 w-5"> Umami</label>
                        </div>
                    </div>
                </section>
                <!-- Parte Afectiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-gray-50 shadow">
                    <h3 class="text-lg font-bold">Afectivo (Puntuación)</h3>
                    <div class="space-y-2">
                        <label for="flavor_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Flavor (Final)</span>
                            <span id="flavor_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="flavor_final" name="flavor_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('flavor_final')">
                    </div>
                    <div class="space-y-2">
                        <label for="aftertaste_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Aftertaste (Final)</span>
                            <span id="aftertaste_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="aftertaste_final" name="aftertaste_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('aftertaste_final')">
                    </div>
                    <div class="space-y-2 mt-4">
                        <label for="flavor_aftertaste_final_notes" class="text-md font-medium text-gray-700">Notes (optional):</label>
                        <textarea id="flavor_aftertaste_final_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-24" placeholder="Notes for final score..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
            </div>
            
            <!-- PASO 3: Acidity -->
            <div id="step-3" class="step-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Paso 3: Acidez</h2>
                <!-- Parte Descriptiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-white shadow">
                    <h3 class="text-lg font-bold">Descriptivo</h3>
                    <div class="space-y-2">
                        <label for="acidity_intensity" class="flex justify-between items-center text-md font-medium">
                            <span>Acidity Intensity</span>
                            <span id="acidity_intensity_val" class="font-bold text-blue-600">7</span>
                        </label>
                        <input type="range" id="acidity_intensity" name="acidity_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('acidity_intensity')">
                    </div>
                    <div class="space-y-2">
                        <h4 class="text-md font-medium">Select one:</h4>
                        <div class="flex flex-col space-y-2">
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg"><input type="radio" name="acidity_type" value="dry" class="form-radio h-5 w-5"> Dry Acidity (Herby, Grassy, Tart)</label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg"><input type="radio" name="acidity_type" value="sweet" class="form-radio h-5 w-5"> Sweet Acidity (Juicy, Fruit-like, Bright)</label>
                        </div>
                    </div>
                </section>
                <!-- Parte Afectiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-gray-50 shadow">
                    <h3 class="text-lg font-bold">Afectivo (Puntuación)</h3>
                    <div class="space-y-2">
                        <label for="acidity_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Acidity (Final)</span>
                            <span id="acidity_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="acidity_final" name="acidity_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('acidity_final')">
                    </div>
                    <div class="space-y-2 mt-4">
                        <label for="acidity_final_notes" class="text-md font-medium text-gray-700">Notes (optional):</label>
                        <textarea id="acidity_final_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-24" placeholder="Notes for final score..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
            </div>
            
            <!-- PASO 4: Sweetness -->
            <div id="step-4" class="step-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Paso 4: Dulzura</h2>
                <!-- Parte Descriptiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-white shadow">
                    <h3 class="text-lg font-bold">Descriptivo</h3>
                    <div class="space-y-2">
                        <label for="sweetness_intensity" class="flex justify-between items-center text-md font-medium">
                            <span>Sweetness Intensity</span>
                            <span id="sweetness_intensity_val" class="font-bold text-blue-600">7</span>
                        </label>
                        <input type="range" id="sweetness_intensity" name="sweetness_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('sweetness_intensity')">
                    </div>
                    <div class="space-y-2">
                         <h4 class="text-md font-medium">Notes (optional):</h4>
                         <textarea id="sweetness_notes" rows="2" class="w-full p-2 border rounded-md bg-gray-50" placeholder="e.g., Honey-like, Caramel..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
                <!-- Parte Afectiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-gray-50 shadow">
                    <h3 class="text-lg font-bold">Afectivo (Puntuación)</h3>
                    <div class="space-y-2">
                        <label for="sweetness_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Sweetness (Final)</span>
                            <span id="sweetness_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="sweetness_final" name="sweetness_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('sweetness_final')">
                    </div>
                    <div class="space-y-2 mt-4">
                        <label for="sweetness_final_notes" class="text-md font-medium text-gray-700">Notes (optional):</label>
                        <textarea id="sweetness_final_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-24" placeholder="Notes for final score..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
            </div>
            
            <!-- PASO 5: Mouthfeel -->
            <div id="step-5" class="step-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Paso 5: Cuerpo (Mouthfeel)</h2>
                <!-- Parte Descriptiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-white shadow">
                    <h3 class="text-lg font-bold">Descriptivo</h3>
                    <div class="space-y-2">
                        <label for="mouthfeel_intensity" class="flex justify-between items-center text-md font-medium">
                            <span>Mouthfeel Intensity</span>
                            <span id="mouthfeel_intensity_val" class="font-bold text-blue-600">7</span>
                        </label>
                        <input type="range" id="mouthfeel_intensity" name="mouthfeel_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('mouthfeel_intensity')">
                    </div>
                    <div class="space-y-2">
                        <h4 class="text-md font-medium">Select up to two:</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg"><input type="checkbox" name="mouthfeel_type" value="rough" class="form-checkbox h-5 w-5"> Rough</label>
                            <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg"><input type="checkbox" name="mouthfeel_type" value="oily" class="form-checkbox h-5 w-5"> Oily</label>
                            <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg"><input type="checkbox" name="mouthfeel_type" value="smooth" class="form-checkbox h-5 w-5"> Smooth</label>
                            <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg"><input type="checkbox" name="mouthfeel_type" value="mouth-drying" class="form-checkbox h-5 w-5"> Mouth-drying</label>
                            <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg"><input type="checkbox" name="mouthfeel_type" value="metallic" class="form-checkbox h-5 w-5"> Metallic</label>
                        </div>
                    </div>
                </section>
                <!-- Parte Afectiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-gray-50 shadow">
                    <h3 class="text-lg font-bold">Afectivo (Puntuación)</h3>
                    <div class="space-y-2">
                        <label for="mouthfeel_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Mouthfeel (Final)</span>
                            <span id="mouthfeel_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="mouthfeel_final" name="mouthfeel_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('mouthfeel_final')">
                    </div>
                    <div class="space-y-2 mt-4">
                        <label for="mouthfeel_final_notes" class="text-md font-medium text-gray-700">Notes (optional):</label>
                        <textarea id="mouthfeel_final_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-24" placeholder="Notes for final score..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
            </div>
            
            <!-- PASO 6: Overall & Defects -->
            <div id="step-6" class="step-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Paso 6: Overall y Defectos</h2>
                <!-- Parte Descriptiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-white shadow">
                    <h3 class="text-lg font-bold">PART 3: EXTRINSIC ASSESSMENT</h3>
                    <div class="space-y-2">
                         <h4 class="text-md font-medium">Notes (optional):</h4>
                         <textarea id="part3_notes" rows="3" class="w-full p-2 border rounded-md bg-gray-50" placeholder="Overall impression, notes..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
                <!-- Parte Afectiva -->
                <section class="border rounded-lg p-4 space-y-4 bg-gray-50 shadow">
                    <h3 class="text-lg font-bold">Afectivo (Puntuación y Defectos)</h3>
                    <div class="space-y-2">
                        <label for="overall_final" class="flex justify-between items-center text-md font-medium text-gray-700">
                            <span>Overall (Final)</span>
                            <span id="overall_final_val" class="font-bold text-gray-700">5</span>
                        </label>
                        <input type="range" id="overall_final" name="overall_final" min="1" max="9" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateSlider('overall_final')">
                    </div>

                    <!-- Bloque de Defectos -->
                    <div class="space-y-3 pt-4 mt-4 border-t border-gray-200">
                        <div>
                            <h4 class="text-md font-medium text-gray-700">NON-UNIFORM CUPS</h4>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="checkbox" name="non_uniform_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="non_uniform_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="non_uniform_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="non_uniform_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="non_uniform_cups" class="form-checkbox h-5 w-5">
                            </div>
                        </div>
                        <div>
                            <h4 class="text-md font-medium text-gray-700">DEFECTIVE CUPS</h4>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="checkbox" name="defective_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="defective_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="defective_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="defective_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="defective_cups" class="form-checkbox h-5 w-5">
                                <input type="checkbox" name="defective_cups" class="form-checkbox h-5 w-5">
                            </div>
                        </div>
                        <div>
                            <h4 class="text-md font-medium text-gray-700">DEFECT (IF ANY)</h4>
                            <div class="flex flex-wrap gap-x-4 gap-y-2 mt-1">
                                <label class="flex items-center gap-2"><input type="checkbox" name="defect_type" value="moldy" class="form-checkbox h-5 w-5"> MOLDY</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="defect_type" value="potato" class="form-checkbox h-5 w-5"> POTATO</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="defect_type" value="phenolic" class="form-checkbox h-5 w-5"> PHENOLIC</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mt-4">
                        <label for="overall_final_notes" class="text-md font-medium text-gray-700">Notes (optional):</label>
                        <textarea id="overall_final_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-24" placeholder="Notes for final score..." oninput="updateNotes(this.id)"></textarea>
                    </div>
                </section>
            </div>

            <!-- PASO 7: Total Score & Export -->
            <div id="step-7" class="step-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">Paso 7: Puntuación Final</h2>
                
                <footer class="p-6 bg-blue-800 text-white rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Total Score</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-blue-700 p-4 rounded-lg">
                            <span class="text-sm font-medium text-blue-200 block">Attribute Score</span>
                            <span id="attribute_score_display" class="text-3xl font-bold">0.00</span>
                        </div>
                        <div class="bg-blue-700 p-4 rounded-lg">
                            <span class="text-sm font-medium text-blue-200 block">Defect Subtraction</span>
                            <span id="defect_score_display" class="text-3xl font-bold">0.00</span>
                        </div>
                        <div class="bg-white text-blue-900 p-4 rounded-lg shadow-inner">
                            <span class="text-sm font-medium text-blue-700 block">Final Score (Base 58.00)</span>
                            <span id="total_score_display" class="text-4xl font-extrabold">58.00</span>
                        </div>
                    </div>
                </footer>

                <div class="p-4 bg-white rounded-lg shadow space-y-4 text-center">
                    <h3 class="text-lg font-bold">Exportar Hoja de Cata</h3>
                    <p class="text-gray-600">Una vez exportado, el PDF se guardará en tus descargas.</p>
                    <button id="exportButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i class="fas fa-file-pdf"></i>
                        <span>Exportar a PDF</span>
                    </button>
                </div>
            </div>

        </main>
    </div> <!-- Fin del cuppingSheetContainer (para PDF) -->

    <!-- Navegación Fija (Footer) -->
    <footer class="p-4 bg-white border-t border-gray-200 shadow-inner grid grid-cols-2 gap-4">
        <button id="prevButton" class="py-3 px-4 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
            Anterior
        </button>
        <button id="nextButton" class="py-3 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50">
            Siguiente
        </button>
    </footer>


    <!-- ============================================= -->
    <!-- === MODAL (Sigue siendo uno solo) === -->
    <!-- ============================================= -->
    <div id="aromaModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <header id="modalHeader" class="p-4 border-b flex justify-between items-center transition-colors duration-300">
                <h2 id="modalTitle" class="text-xl font-bold">Select Aroma</h2>
                <button onclick="closeAromaModal()" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </header>
            
            <div class="p-4 overflow-y-auto flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <!-- Nivel 2 -->
                <div class="flex-1">
                    <h3 class="font-semibold mb-2 text-gray-500">Nivel 2 (Anillo 2)</h3>
                    <ul id="level2List" class="space-y-2"></ul>
                </div>
                <!-- Nivel 3 -->
                <div class="flex-1">
                    <h3 class="font-semibold mb-2 text-gray-500">Nivel 3 (Anillo 3)</h3>
                    <ul id="level3List" class="space-y-2">
                        <li class="text-gray-400 p-3 rounded-md">Seleccione una opción del Nivel 2</li>
                    </ul>
                </div>
            </div>
            
            <footer class="p-4 border-t bg-gray-50 rounded-b-lg text-right">
                <p id="modalSelection" class="text-sm text-gray-600 text-left">Selección: N/A</p>
            </footer>
        </div>
    </div>
    
    <!-- Mensaje de Límite -->
    <div id="limitMessage" class="hidden fixed bottom-20 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg transition-all duration-300 z-50">
        Ya has seleccionado 5 descriptores para esta sección.
    </div>


    <script>
        // =============================================
        // === LÓGICA DE NAVEGACIÓN POR PASOS ===
        // =============================================
        
        let currentStep = 0;
        const totalSteps = 8; // 0-7
        const steps = document.querySelectorAll('.step-content');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        function showStep(stepIndex) {
            // Ocultar todos los pasos
            steps.forEach((step, index) => {
                if (index === stepIndex) {
                    step.classList.remove('hidden');
                } else {
                    step.classList.add('hidden');
                }
            });

            // Actualizar barra de progreso
            const progressPercent = (stepIndex / (totalSteps - 1)) * 100;
            progressBar.style.width = `${progressPercent}%`;
            progressText.textContent = `Paso ${stepIndex} de ${totalSteps - 1}`;
            
            // Actualizar botones
            prevButton.disabled = stepIndex === 0;
            
            if (stepIndex === totalSteps - 1) {
                // Último paso (Resumen)
                nextButton.textContent = 'Finalizar';
                nextButton.disabled = true; // Deshabilitar para evitar confusiones
                // Recalcular el score por si acaso
                calculateTotalScore();
            } else {
                nextButton.textContent = 'Siguiente';
                nextButton.disabled = false;
            }

            // Scroll al inicio de la página
            document.getElementById('cuppingSheetContainer').scrollTop = 0;
        }

        prevButton.addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
            }
        });

        nextButton.addEventListener('click', () => {
            if (currentStep < totalSteps - 1) {
                currentStep++;
                showStep(currentStep);
            }
        });


        // =============================================
        // === LÓGICA DE LA APP (sin cambios) ===
        // =============================================

        // --- BASE DE DATOS DE LA RUEDA DE AROMAS (con colores) ---
        const aromaWheel = {
            'FLORAL': {
                btnColor: 'bg-pink-200', btnTextColor: 'text-pink-900', btnHover: 'hover:bg-pink-300',
                modalHeader: 'bg-pink-200', modalTitleColor: 'text-pink-900',
                modalBtnColor: 'bg-pink-50', modalBtnHover: 'hover:bg-pink-100', modalBtnText: 'text-pink-800',
                tagColor: 'bg-pink-200', tagTextColor: 'text-pink-900',
                sub: { 'Floral': ['Manzanilla (Chamomile)', 'Rosa (Rose)', 'Jazmín (Jasmine)', 'Ninguno de estos'], 'Té Negro (Black Tea)': ['Té Negro', 'Ninguno de estos'] }
            },
            'FRUITY': {
                btnColor: 'bg-red-200', btnTextColor: 'text-red-900', btnHover: 'hover:bg-red-300',
                modalHeader: 'bg-red-200', modalTitleColor: 'text-red-900',
                modalBtnColor: 'bg-red-50', modalBtnHover: 'hover:bg-red-100', modalBtnText: 'text-red-800',
                tagColor: 'bg-red-200', tagTextColor: 'text-red-900',
                sub: { 'Bayas (Berry)': ['Mora (Blackberry)', 'Frambuesa (Raspberry)', 'Arándano (Blueberry)', 'Fresa (Strawberry)', 'Ninguno de estos'], 'Fruta Seca (Dried Fruit)': ['Pasa (Raisin)', 'Ciruela Pasa (Prune)', 'Ninguno de estos'], 'Cítrico (Citrus Fruit)': ['Toronja (Grapefruit)', 'Naranja (Orange)', 'Limón (Lemon)', 'Lima (Lime)', 'Ninguno de estos'], 'Otra Fruta (Other Fruit)': ['Coco (Coconut)', 'Cereza (Cherry)', 'Granada (Pomegranate)', 'Piña (Pineapple)', 'Uva (Grape)', 'Manzana (Apple)', 'Pera (Pear)', 'Durazno (Peach)', 'Ninguno de estos'] }
            },
            'SOUR/FERMENTED': {
                btnColor: 'bg-yellow-200', btnTextColor: 'text-yellow-900', btnHover: 'hover:bg-yellow-300',
                modalHeader: 'bg-yellow-200', modalTitleColor: 'text-yellow-900',
                modalBtnColor: 'bg-yellow-50', modalBtnHover: 'hover:bg-yellow-100', modalBtnText: 'text-yellow-800',
                tagColor: 'bg-yellow-200', tagTextColor: 'text-yellow-900',
                sub: { 'Agrio (Sour)': ['Ácido acético (Acetic)', 'Ácido butírico (Butyric)', 'Ácido isovalérico (Isovaleric)', 'Ácido cítrico (Citric)', 'Ácido málico (Malic)', 'Ninguno de estos'], 'Fermentado (Fermented)': ['Alcohólico (Alcohol)', 'Vino (Winey)', 'Whisky', 'Sobre-maduro (Overripe)', 'Ninguno de estos'] }
            },
            'GREEN/VEGETATIVE': {
                btnColor: 'bg-green-200', btnTextColor: 'text-green-900', btnHover: 'hover:bg-green-300',
                modalHeader: 'bg-green-200', modalTitleColor: 'text-green-900',
                modalBtnColor: 'bg-green-50', modalBtnHover: 'hover:bg-green-100', modalBtnText: 'text-green-800',
                tagColor: 'bg-green-200', tagTextColor: 'text-green-900',
                sub: { 'Aceite de Oliva (Olive Oil)': ['Aceite de Oliva', 'Ninguno de estos'], 'Crudo (Raw)': ['Crudo', 'Ninguno de estos'], 'Verde/Vegetal (Green/Vegetative)': ['Bajo-desarrollo (Under-developed)', 'Pasto (Grassy)', 'Hierba (Herb-like)', 'Heno (Hay-like)', 'Ninguno de estos'], 'Leguminoso (Beany)': ['Leguminoso', 'Ninguno de estos'] }
            },
            'OTHER': {
                btnColor: 'bg-purple-200', btnTextColor: 'text-purple-900', btnHover: 'hover:bg-purple-300',
                modalHeader: 'bg-purple-200', modalTitleColor: 'text-purple-900',
                modalBtnColor: 'bg-purple-50', modalBtnHover: 'hover:bg-purple-100', modalBtnText: 'text-purple-800',
                tagColor: 'bg-purple-200', tagTextColor: 'text-purple-900',
                sub: { 'Papel/Cartón (Papery/Musty)': ['Papel (Paper)', 'Cartón (Cardboard)', 'Moho (Musty)', 'Tierra (Earthy)', 'Polvo (Dusty)', 'Ninguno de estos'], 'Químico (Chemical)': ['Medicinal (Medicinal)', 'Goma (Rubber)', 'Petróleo (Petroleum)', 'Gas (Skunky)', 'Ninguno de estos'] }
            },
            'ROASTED': {
                btnColor: 'bg-zinc-700', btnTextColor: 'text-zinc-50', btnHover: 'hover:bg-zinc-600',
                modalHeader: 'bg-zinc-700', modalTitleColor: 'text-zinc-50',
                modalBtnColor: 'bg-zinc-100', modalBtnHover: 'hover:bg-zinc-200', modalBtnText: 'text-zinc-800',
                tagColor: 'bg-zinc-700', tagTextColor: 'text-zinc-50',
                sub: { 
                    'Cereal (Cereal)': ['Cereal', 'Ninguno de estos'], 
                    'Malt (Malt)': ['Malt', 'Ninguno de estos'], 
                    'Tabaco (Tobacco)': ['Tabaco', 'Ninguno de estos'], 
                    'Tostado (Roasted)': ['Quemado (Burnt)', 'Ahumado (Smoky)', 'Ceniza (Ashy)', 'Ninguno de estos'] 
                }
            },
            'NUTTY/COCOA': {
                btnColor: 'bg-orange-300', btnTextColor: 'text-orange-900', btnHover: 'hover:bg-orange-400',
                modalHeader: 'bg-orange-300', modalTitleColor: 'text-orange-900',
                modalBtnColor: 'bg-orange-50', modalBtnHover: 'hover:bg-orange-100', modalBtnText: 'text-orange-800',
                tagColor: 'bg-orange-300', tagTextColor: 'text-orange-900',
                sub: { 'Nuez (Nutty)': ['Maní (Peanut)', 'Avellana (Hazelnut)', 'Almendra (Almond)', 'Ninguno de estos'], 'Cacao (Cocoa)': ['Chocolate', 'Chocolate Amargo (Dark Chocolate)', 'Ninguno de estos'] }
            },
            'SPICY': {
                btnColor: 'bg-amber-500', btnTextColor: 'text-amber-50', btnHover: 'hover:bg-amber-600',
                modalHeader: 'bg-amber-500', modalTitleColor: 'text-amber-50',
                modalBtnColor: 'bg-amber-50', modalBtnHover: 'hover:bg-amber-100', modalBtnText: 'text-amber-800',
                tagColor: 'bg-amber-500', tagTextColor: 'text-amber-50',
                sub: { 'Especias (Spices)': ['Anís (Anise)', 'Nuez Moscada (Nutmeg)', 'Canela (Cinnamon)', 'Clavo (Clove)', 'Pimienta (Pepper)', 'Ninguno de estos'] }
            },
            'SWEET': {
                btnColor: 'bg-blue-200', btnTextColor: 'text-blue-900', btnHover: 'hover:bg-blue-300',
                modalHeader: 'bg-blue-200', modalTitleColor: 'text-blue-900',
                modalBtnColor: 'bg-blue-50', modalBtnHover: 'hover:bg-blue-100', modalBtnText: 'text-blue-800',
                tagColor: 'bg-blue-200', tagTextColor: 'text-blue-900',
                sub: { 'Vainilla (Vanilla)': ['Vainilla', 'Ninguno de estos'], 'Azúcar Morena (Brown Sugar)': ['Melaza (Molasses)', 'Caramelo (Caramel)', 'Miel (Honey)', 'Ninguno de estos'] }
            }
        };
 
        // --- ESTADO DE LA APP ---
        let cuppingData = {
            metadata: {
                nombre: "",
                fecha: "",
                cafe: ""
            },
            descriptive: {
                fragrance_intensity: 7,
                aroma_intensity: 7,
                fragrance_aromas: [], // Lista 1
                flavor_intensity: 7,
                aftertaste_intensity: 7,
                flavor_aromas: [], // Lista 2
                main_tastes: [],
                acidity_intensity: 7,
                acidity_type: null,
                sweetness_intensity: 7,
                sweetness_notes: "",
                mouthfeel_intensity: 7,
                mouthfeel_types: [],
                part3_notes: ""
            },
            affective: {
                fragrance_final: 5, aroma_final: 5, flavor_final: 5, aftertaste_final: 5,
                acidity_final: 5, sweetness_final: 5, mouthfeel_final: 5, overall_final: 5,
                fragrance_aroma_final_notes: "",
                flavor_aftertaste_final_notes: "",
                acidity_final_notes: "",
                sweetness_final_notes: "",
                mouthfeel_final_notes: "",
                overall_final_notes: "",
                non_uniform_cups: 0,
                defective_cups: 0,
                defects: []
            }
        };
        
        // --- ESTADO DEL MODAL (temporal) ---
        let modalState = {
            currentListKey: null, // 'fragrance_aromas' o 'flavor_aromas'
            currentCategory: null, 
            currentL2: null
        };

        // --- FUNCIONES ---

        function updateSlider(sliderId) {
            const slider = document.getElementById(sliderId);
            const output = document.getElementById(sliderId + '_val');
            output.textContent = slider.value;
            
            const isAffective = sliderId.includes('_final');
            const section = isAffective ? 'affective' : 'descriptive';
            
            let key = sliderId;
            if (isAffective) {
                key = sliderId;
            } else {
                key = sliderId;
            }
            
            cuppingData[section][key] = slider.value;
            
            if (isAffective) {
                calculateTotalScore();
            }
        }

        function updateNotes(id) {
            const textarea = document.getElementById(id);
            const isAffective = id.includes('_final_');
            
            if (isAffective) {
                cuppingData.affective[id] = textarea.value;
            } else {
                if (id === 'sweetness_notes') {
                    cuppingData.descriptive.sweetness_notes = textarea.value;
                } else if (id === 'part3_notes') {
                    cuppingData.descriptive.part3_notes = textarea.value;
                }
            }
        }
        
        function showLimitMessage() {
            const msg = document.getElementById('limitMessage');
            msg.classList.remove('hidden');
            setTimeout(() => {
                msg.classList.add('hidden');
            }, 2000);
        }

        function openAromaModal(category, listKey) {
            if (cuppingData.descriptive[listKey].length >= 5) {
                showLimitMessage();
                return;
            }
            
            modalState.currentListKey = listKey;
            modalState.currentCategory = category;
            
            const modal = document.getElementById('aromaModal');
            const modalHeader = document.getElementById('modalHeader');
            const title = document.getElementById('modalTitle');
            const l2List = document.getElementById('level2List');
            const l3List = document.getElementById('level3List');
            
            const categoryData = aromaWheel[category];
            
            modalHeader.className = `p-4 border-b flex justify-between items-center transition-colors duration-300 ${categoryData.modalHeader}`;
            title.className = `text-xl font-bold ${categoryData.modalTitleColor}`;
            title.textContent = `Seleccionar: ${category}`;
            
            l2List.innerHTML = '';
            l3List.innerHTML = '<li class="text-gray-400 p-3 rounded-md">Seleccione una opción del Nivel 2</li>';
            updateModalSelection();

            const l2Categories = categoryData.sub;
            for (const l2Name in l2Categories) {
                const li = document.createElement('li');
                li.textContent = l2Name;
                li.className = `p-3 rounded-md cursor-pointer break-words ${categoryData.modalBtnColor} ${categoryData.modalBtnText} ${categoryData.modalBtnHover}`;
                li.onclick = () => selectL2(l2Name);
                l2List.appendChild(li);
            }
            
            modal.classList.remove('hidden');
        }

        function closeAromaModal() {
            document.getElementById('aromaModal').classList.add('hidden');
            modalState = { currentListKey: null, currentCategory: null, currentL2: null };
        }
        
        function selectL2(l2Name) {
            modalState.currentL2 = l2Name;
            
            const categoryData = aromaWheel[modalState.currentCategory];
            const l3List = document.getElementById('level3List');
            l3List.innerHTML = ''; 
            updateModalSelection();
            
            const baseClass = `p-3 rounded-md cursor-pointer break-words ${categoryData.modalBtnColor} ${categoryData.modalBtnText} ${categoryData.modalBtnHover}`;
            const activeClass = `p-3 rounded-md cursor-pointer break-words ${categoryData.modalBtnHover.replace('hover:', '')} ${categoryData.modalBtnText}`;

            Array.from(document.getElementById('level2List').children).forEach(child => {
                if (child.textContent === l2Name) {
                    child.className = activeClass;
                } else {
                    child.className = baseClass;
                }
            });

            const l3Items = aromaWheel[modalState.currentCategory].sub[l2Name];
            for (const l3Name of l3Items) {
                const li = document.createElement('li');
                li.textContent = l3Name;
                li.className = baseClass;
                li.onclick = () => selectL3(l3Name);
                l3List.appendChild(li);
            }
        }
        
        function selectL3(l3Name) {
            const { currentCategory, currentL2, currentListKey } = modalState;
            
            if (l3Name === 'Ninguno de estos') {
                 if (aromaWheel[currentCategory].sub[currentL2].length > 1) { 
                     addAroma(currentListKey, `${currentCategory} > ${currentL2}`, currentCategory);
                 } else {
                     addAroma(currentListKey, `${currentCategory} > ${currentL2}`, currentCategory);
                 }
            } else {
                addAroma(currentListKey, `${currentCategory} > ${currentL2} > ${l3Name}`, currentCategory);
            }

            closeAromaModal();
        }
        
        function addAroma(listKey, aromaString, category) {
            if (cuppingData.descriptive[listKey].length < 5) {
                cuppingData.descriptive[listKey].push({ text: aromaString, category: category });
                renderTags(listKey);
            }
        }
        
        function removeAroma(listKey, aromaString) {
            cuppingData.descriptive[listKey] = cuppingData.descriptive[listKey].filter(a => a.text !== aromaString);
            renderTags(listKey);
        }
        
        function renderTags(listKey) {
            const tagsContainer = document.getElementById(listKey === 'fragrance_aromas' ? 'fragrance_aroma_tags' : 'flavor_aroma_tags');
            tagsContainer.innerHTML = ''; 
            
            cuppingData.descriptive[listKey].forEach(aromaObj => {
                const categoryData = aromaWheel[aromaObj.category];
                const tag = document.createElement('div');
                tag.className = `aroma-tag ${categoryData.tagColor} ${categoryData.tagTextColor}`;
                tag.innerHTML = `
                    <span class="aroma-tag-text">${aromaObj.text}</span>
                    <button onclick="removeAroma('${listKey}', '${aromaObj.text.replace(/'/g, "\\'")}')" class="focus:outline-none">&times;</button>
                `;
                tagsContainer.appendChild(tag);
            });
        }

        function updateModalSelection() {
            const { currentCategory, currentL2 } = modalState;
            const selEl = document.getElementById('modalSelection');
            if (!currentCategory) selEl.textContent = 'Selección: N/A';
            else if (!currentL2) selEl.textContent = `Selección: ${currentCategory}`;
            else selEl.textContent = `Selección: ${currentCategory} > ${currentL2}`;
        }

        function renderAromaGrid(containerId, listKey) {
            const gridContainer = document.getElementById(containerId);
            gridContainer.innerHTML = ''; 
            
            for (const category in aromaWheel) {
                const categoryData = aromaWheel[category];
                const button = document.createElement('button');
                
                button.textContent = category;
                button.className = `aroma-btn p-3 rounded-lg font-semibold transition-colors duration-200 h-full ${categoryData.btnColor} ${categoryData.btnTextColor} ${categoryData.btnHover}`;
                                
                button.onclick = () => openAromaModal(category, listKey);
                gridContainer.appendChild(button);
            }
        }
        
        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Mostrar el primer paso
            showStep(currentStep);

            // Dibuja ambas grillas
            renderAromaGrid('fragrance_aroma_grid', 'fragrance_aromas');
            renderAromaGrid('flavor_aroma_grid', 'flavor_aromas');

            // --- Listeners de Metadatos ---
            const fechaInput = document.getElementById('catador_fecha');
            fechaInput.valueAsDate = new Date(); 
            cuppingData.metadata.fecha = fechaInput.value; 
            
            fechaInput.addEventListener('input', (e) => {
                cuppingData.metadata.fecha = e.target.value;
            });
            document.getElementById('catador_nombre').addEventListener('input', (e) => {
                cuppingData.metadata.nombre = e.target.value;
            });
            document.getElementById('catador_cafe').addEventListener('input', (e) => {
                cuppingData.metadata.cafe = e.target.value;
            });
            
            // Listener del botón de exportar
            document.getElementById('exportButton').addEventListener('click', exportToPDF);
            
            // --- Event Listeners para Defectos ---
            document.querySelectorAll('input[name="non_uniform_cups"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    cuppingData.affective.non_uniform_cups = 
                        document.querySelectorAll('input[name="non_uniform_cups"]:checked').length;
                    calculateTotalScore();
                });
            });
            
            document.querySelectorAll('input[name="defective_cups"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    cuppingData.affective.defective_cups = 
                        document.querySelectorAll('input[name="defective_cups"]:checked').length;
                    calculateTotalScore();
                });
            });
            
            document.querySelectorAll('input[name="defect_type"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    cuppingData.affective.defects = 
                        Array.from(document.querySelectorAll('input[name="defect_type"]:checked'))
                             .map(cb => cb.value);
                });
            });

            // Calcular puntaje inicial (mostrará 58.00 + score de defaults)
            calculateTotalScore();
        });

        // --- FUNCIÓN DE CÁLCULO ---
        const sliderValuePoints = {
            '1': 0.00, '2': 0.75, '3': 1.25, '4': 2.00, '5': 2.75, 
            '6': 3.25, '7': 4.00, '8': 4.50, '9': 5.25
        };

        function calculateTotalScore() {
            const baseScore = 58.00;
            let attributeScore = 0;
            
            const affectiveSliders = [
                'fragrance_final', 'aroma_final', 'flavor_final', 'aftertaste_final',
                'acidity_final', 'sweetness_final', 'mouthfeel_final', 'overall_final'
            ];
            
            affectiveSliders.forEach(sliderId => {
                const sliderValue = cuppingData.affective[sliderId] || '1';
                attributeScore += sliderValuePoints[sliderValue.toString()];
            });
            
            const nonUniformPoints = cuppingData.affective.non_uniform_cups * 2;
            const defectivePoints = cuppingData.affective.defective_cups * 4;
            const defectSubtraction = nonUniformPoints + defectivePoints;
            
            const totalScore = baseScore + attributeScore - defectSubtraction;
            
            document.getElementById('attribute_score_display').textContent = attributeScore.toFixed(2);
            document.getElementById('defect_score_display').textContent = `-${defectSubtraction.toFixed(2)}`;
            document.getElementById('total_score_display').textContent = totalScore.toFixed(2);
        }

        // --- FUNCIÓN DE EXPORTAR PDF ---
        function exportToPDF() {
            const { nombre, cafe, fecha } = cuppingData.metadata;

            const cleanNombre = nombre.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'catador';
            const cleanCafe = cafe.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'cafe';
            const cleanFecha = fecha.replace(/-/g, '') || 'fecha';
            
            const filename = `${cleanNombre}_${cleanCafe}_${cleanFecha}.pdf`;
            
            // Elemento a exportar
            const cuppingSheet = document.getElementById('cuppingSheetContainer');
            
            // Mostrar todos los pasos para la captura
            steps.forEach(step => step.classList.remove('hidden'));

            const exportButton = document.getElementById('exportButton');
            const originalButtonText = exportButton.innerHTML;
            exportButton.disabled = true;
            exportButton.innerHTML = 'Exportando...';

            html2canvas(cuppingSheet, {
                scale: 2 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const imgWidth = 210; 
                const pageHeight = 297; 
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                const doc = new jsPDF('p', 'mm', 'a4');
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save(filename);

                exportButton.disabled = false;
                exportButton.innerHTML = originalButtonText;

                // Ocultar los pasos nuevamente y volver al paso actual
                showStep(currentStep);
            });
        }

    </script>

    <!-- === AÑADIDO PARA PWA: Registro del Service Worker === -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con éxito:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Fallo en el registro del ServiceWorker:', error);
                    });
            });
        }
    </script>
    <!-- === FIN PWA === -->

</body>
</html>
