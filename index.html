<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA Coffee Cupping App</title>
    
    <!-- PWA Manifest y Tema -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e40af">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1e40af/FFFFFF?text=SCA">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Dependencias: Iconos y PDF -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        
        /* Tags de Aromas */
        .aroma-tag {
            display: inline-flex; align-items: center; padding: 4px 10px; margin: 4px;
            border-radius: 16px; font-size: 0.875rem; font-weight: 500; max-width: 100%; 
        }
        .aroma-tag-text { flex-grow: 1; word-wrap: break-word; white-space: normal; }
        .aroma-tag button { margin-left: 8px; font-weight: bold; opacity: 0.7; flex-shrink: 0; }

        /* Acordeón */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            max-height: 0; opacity: 0; overflow: hidden;
        }
        .accordion-content.open {
            max-height: 5000px; opacity: 1; overflow: visible;
        }
        .accordion-header i { transition: transform 0.3s ease; }
        .accordion-header.open i { transform: rotate(90deg); }

        /* Estilos para Tabs */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen">

    <!-- Cabecera Fija -->
    <header class="bg-blue-800 text-white shadow-md z-10 flex flex-col">
        <div class="p-3 text-center">
            <h1 class="text-lg font-bold">SCA Coffee Value by Penguin Coffee Roasters</h1>
        </div>

        <!-- BARRA DE PESTAÑAS -->
        <div class="flex items-end px-2 space-x-1 overflow-x-auto no-scrollbar select-none" id="tabsContainer">
            <!-- Las pestañas se generarán aquí con JS -->
        </div>
    </header>

    <!-- Contenedor Principal (Scrollable) -->
    <div id="cuppingSheetContainer" class="flex-1 overflow-y-auto bg-gray-50">
        <main class="p-4 space-y-3 pb-24"> <!-- Padding bottom extra para el footer -->

            <!-- PASO 0: Información -->
            <div class="accordion-item bg-white rounded-lg shadow border border-gray-200">
                <button class="accordion-header open w-full flex justify-between items-center p-4 text-left">
                    <h2 class="text-xl font-semibold text-gray-700">Información de la Cata</h2>
                    <i class="fas fa-chevron-down text-blue-600"></i>
                </button>
                <div class="accordion-content open p-4 pt-0 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre (Catador):</label>
                        <input type="text" id="catador_nombre" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Tu nombre...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fecha:</label>
                        <input type="date" id="catador_fecha" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Café (Muestra):</label>
                        <input type="text" id="catador_cafe" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none font-bold text-blue-900" placeholder="Ej: Colombia Lavado">
                    </div>
                </div>
            </div>

            <!-- PASO 1: Fragancia y Aroma -->
            <div class="accordion-item bg-white rounded-lg shadow border border-gray-200">
                <button class="accordion-header w-full flex justify-between items-center p-4 text-left">
                    <h2 class="text-xl font-semibold text-gray-700">1. Fragancia y Aroma</h2>
                    <i class="fas fa-chevron-right text-blue-600"></i>
                </button>
                <div class="accordion-content p-4 pt-0 space-y-6">
                    <section class="border rounded-lg p-4 space-y-4 bg-gray-50">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium"><span>Fragrance Intensity</span><span id="fragrance_intensity_val" class="font-bold text-blue-600">7</span></label>
                            <input type="range" id="fragrance_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium"><span>Aroma Intensity</span><span id="aroma_intensity_val" class="font-bold text-blue-600">7</span></label>
                            <input type="range" id="aroma_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-3">
                            <h4 class="text-md font-medium">Select up to five:</h4>
                            <div id="fragrance_aroma_tags" class="flex flex-wrap -m-1"></div>
                            <div id="fragrance_aroma_grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                        </div>
                    </section>
                    <section class="border rounded-lg p-4 space-y-4 bg-blue-50 border-blue-100">
                        <h3 class="text-sm font-bold text-blue-800 uppercase">Puntuación</h3>
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Fragrance Score</span><span id="fragrance_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="fragrance_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Aroma Score</span><span id="aroma_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="aroma_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2 mt-4">
                            <textarea id="fragrance_aroma_final_notes" class="w-full p-2 border border-blue-200 rounded-md bg-white h-20 text-sm" placeholder="Notas..." oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                </div>
            </div>

            <!-- PASO 2: Sabor y Postgusto -->
            <div class="accordion-item bg-white rounded-lg shadow border border-gray-200">
                <button class="accordion-header w-full flex justify-between items-center p-4 text-left">
                    <h2 class="text-xl font-semibold text-gray-700">2. Sabor y Postgusto</h2>
                    <i class="fas fa-chevron-right text-blue-600"></i>
                </button>
                <div class="accordion-content p-4 pt-0 space-y-6">
                    <section class="border rounded-lg p-4 space-y-4 bg-gray-50">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium"><span>Flavor Intensity</span><span id="flavor_intensity_val" class="font-bold text-blue-600">7</span></label>
                            <input type="range" id="flavor_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium"><span>Aftertaste Intensity</span><span id="aftertaste_intensity_val" class="font-bold text-blue-600">7</span></label>
                            <input type="range" id="aftertaste_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-3">
                            <h4 class="text-md font-medium">Select up to five:</h4>
                            <div id="flavor_aroma_tags" class="flex flex-wrap -m-1"></div>
                            <div id="flavor_aroma_grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                        </div>
                        <div class="space-y-2">
                            <h4 class="text-md font-medium">Main Tastes (Max 2):</h4>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-1 bg-white px-2 py-1 rounded border"><input type="checkbox" name="main_taste" value="Salty"> Salty</label>
                                <label class="flex items-center gap-1 bg-white px-2 py-1 rounded border"><input type="checkbox" name="main_taste" value="Sour"> Sour</label>
                                <label class="flex items-center gap-1 bg-white px-2 py-1 rounded border"><input type="checkbox" name="main_taste" value="Sweet"> Sweet</label>
                                <label class="flex items-center gap-1 bg-white px-2 py-1 rounded border"><input type="checkbox" name="main_taste" value="Bitter"> Bitter</label>
                                <label class="flex items-center gap-1 bg-white px-2 py-1 rounded border"><input type="checkbox" name="main_taste" value="Umami"> Umami</label>
                            </div>
                        </div>
                    </section>
                    <section class="border rounded-lg p-4 space-y-4 bg-blue-50 border-blue-100">
                        <h3 class="text-sm font-bold text-blue-800 uppercase">Puntuación</h3>
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Flavor Score</span><span id="flavor_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="flavor_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Aftertaste Score</span><span id="aftertaste_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="aftertaste_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>
                         <div class="space-y-2 mt-4">
                            <textarea id="flavor_aftertaste_final_notes" class="w-full p-2 border border-blue-200 rounded-md bg-white h-20 text-sm" placeholder="Notas..." oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                </div>
            </div>

            <!-- PASO 3: Acidez -->
            <div class="accordion-item bg-white rounded-lg shadow border border-gray-200">
                <button class="accordion-header w-full flex justify-between items-center p-4 text-left">
                    <h2 class="text-xl font-semibold text-gray-700">3. Acidez</h2>
                    <i class="fas fa-chevron-right text-blue-600"></i>
                </button>
                <div class="accordion-content p-4 pt-0 space-y-6">
                    <section class="border rounded-lg p-4 space-y-4 bg-gray-50">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium"><span>Acidity Intensity</span><span id="acidity_intensity_val" class="font-bold text-blue-600">7</span></label>
                            <input type="range" id="acidity_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2">
                            <h4 class="text-md font-medium">Type:</h4>
                            <div class="flex flex-col space-y-2">
                                <label class="flex items-center gap-2 bg-white p-2 rounded border"><input type="radio" name="acidity_type" value="dry" class="h-4 w-4 text-blue-600" onchange="updateRadio('acidity_type')"> Dry Acidity (Herby, Tart)</label>
                                <label class="flex items-center gap-2 bg-white p-2 rounded border"><input type="radio" name="acidity_type" value="sweet" class="h-4 w-4 text-blue-600" onchange="updateRadio('acidity_type')"> Sweet Acidity (Juicy, Bright)</label>
                            </div>
                        </div>
                    </section>
                    <section class="border rounded-lg p-4 space-y-4 bg-blue-50 border-blue-100">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Acidity Score</span><span id="acidity_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="acidity_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2 mt-4">
                            <textarea id="acidity_final_notes" class="w-full p-2 border border-blue-200 rounded-md bg-white h-20 text-sm" placeholder="Notas..." oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                </div>
            </div>

            <!-- PASO 4: Dulzura -->
            <div class="accordion-item bg-white rounded-lg shadow border border-gray-200">
                <button class="accordion-header w-full flex justify-between items-center p-4 text-left">
                    <h2 class="text-xl font-semibold text-gray-700">4. Dulzura</h2>
                    <i class="fas fa-chevron-right text-blue-600"></i>
                </button>
                <div class="accordion-content p-4 pt-0 space-y-6">
                    <section class="border rounded-lg p-4 space-y-4 bg-gray-50">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium"><span>Sweetness Intensity</span><span id="sweetness_intensity_val" class="font-bold text-blue-600">7</span></label>
                            <input type="range" id="sweetness_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider(this.id)">
                        </div>
                         <div class="space-y-2">
                            <textarea id="sweetness_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-16 text-sm" placeholder="Notas descriptivas (Caramelo, Miel...)" oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                    <section class="border rounded-lg p-4 space-y-4 bg-blue-50 border-blue-100">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Sweetness Score</span><span id="sweetness_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="sweetness_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2 mt-4">
                            <textarea id="sweetness_final_notes" class="w-full p-2 border border-blue-200 rounded-md bg-white h-20 text-sm" placeholder="Notas..." oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                </div>
            </div>

            <!-- PASO 5: Cuerpo -->
            <div class="accordion-item bg-white rounded-lg shadow border border-gray-200">
                <button class="accordion-header w-full flex justify-between items-center p-4 text-left">
                    <h2 class="text-xl font-semibold text-gray-700">5. Cuerpo (Mouthfeel)</h2>
                    <i class="fas fa-chevron-right text-blue-600"></i>
                </button>
                <div class="accordion-content p-4 pt-0 space-y-6">
                    <section class="border rounded-lg p-4 space-y-4 bg-gray-50">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium"><span>Mouthfeel Intensity</span><span id="mouthfeel_intensity_val" class="font-bold text-blue-600">7</span></label>
                            <input type="range" id="mouthfeel_intensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSlider(this.id)">
                        </div>
                         <div class="space-y-2">
                            <h4 class="text-md font-medium">Select up to two:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2 bg-white p-2 rounded border"><input type="checkbox" name="mouthfeel_type" value="Rough"> Rough</label>
                                <label class="flex items-center gap-2 bg-white p-2 rounded border"><input type="checkbox" name="mouthfeel_type" value="Oily"> Oily</label>
                                <label class="flex items-center gap-2 bg-white p-2 rounded border"><input type="checkbox" name="mouthfeel_type" value="Smooth"> Smooth</label>
                                <label class="flex items-center gap-2 bg-white p-2 rounded border"><input type="checkbox" name="mouthfeel_type" value="Metallic"> Metallic</label>
                                <label class="flex items-center gap-2 bg-white p-2 rounded border"><input type="checkbox" name="mouthfeel_type" value="Mouth-drying"> Mouth-drying</label>
                            </div>
                        </div>
                    </section>
                    <section class="border rounded-lg p-4 space-y-4 bg-blue-50 border-blue-100">
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Mouthfeel Score</span><span id="mouthfeel_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="mouthfeel_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>
                        <div class="space-y-2 mt-4">
                            <textarea id="mouthfeel_final_notes" class="w-full p-2 border border-blue-200 rounded-md bg-white h-20 text-sm" placeholder="Notas..." oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                </div>
            </div>

            <!-- PASO 6: Overall y Defectos -->
            <div class="accordion-item bg-white rounded-lg shadow border border-gray-200">
                <button class="accordion-header w-full flex justify-between items-center p-4 text-left">
                    <h2 class="text-xl font-semibold text-gray-700">6. Overall y Defectos</h2>
                    <i class="fas fa-chevron-right text-blue-600"></i>
                </button>
                <div class="accordion-content p-4 pt-0 space-y-6">
                    <section class="border rounded-lg p-4 space-y-4 bg-gray-50">
                        <h3 class="text-lg font-bold">PART 3: EXTRINSIC</h3>
                        <div class="space-y-2">
                            <textarea id="part3_notes" class="w-full p-2 border border-gray-300 rounded-md bg-white h-20" placeholder="Impresión general..." oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                    <section class="border rounded-lg p-4 space-y-4 bg-blue-50 border-blue-100">
                        <h3 class="text-lg font-bold text-blue-800">Afectivo</h3>
                        <div class="space-y-2">
                            <label class="flex justify-between items-center text-md font-medium text-gray-700"><span>Overall Score</span><span id="overall_final_val" class="font-bold text-gray-700">5</span></label>
                            <input type="range" id="overall_final" min="1" max="9" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateSlider(this.id)">
                        </div>

                        <div class="space-y-3 pt-4 mt-4 border-t border-blue-200">
                            <div>
                                <h4 class="text-md font-medium text-gray-700">NON-UNIFORM CUPS (x2 pts)</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="checkbox" name="non_uniform_cups" class="h-5 w-5 text-red-600"> <input type="checkbox" name="non_uniform_cups" class="h-5 w-5 text-red-600"> <input type="checkbox" name="non_uniform_cups" class="h-5 w-5 text-red-600"> <input type="checkbox" name="non_uniform_cups" class="h-5 w-5 text-red-600"> <input type="checkbox" name="non_uniform_cups" class="h-5 w-5 text-red-600">
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-medium text-gray-700">DEFECTIVE CUPS (x4 pts)</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="checkbox" name="defective_cups" class="h-5 w-5 text-red-800"> <input type="checkbox" name="defective_cups" class="h-5 w-5 text-red-800"> <input type="checkbox" name="defective_cups" class="h-5 w-5 text-red-800"> <input type="checkbox" name="defective_cups" class="h-5 w-5 text-red-800"> <input type="checkbox" name="defective_cups" class="h-5 w-5 text-red-800"> <input type="checkbox" name="defective_cups" class="h-5 w-5 text-red-800">
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-medium text-gray-700">DEFECT TYPE</h4>
                                <div class="flex flex-wrap gap-x-4 gap-y-2 mt-1">
                                    <label class="flex items-center gap-2"><input type="checkbox" name="defect_type" value="moldy" class="h-5 w-5 text-red-600"> MOLDY</label>
                                    <label class="flex items-center gap-2"><input type="checkbox" name="defect_type" value="potato" class="h-5 w-5 text-red-600"> POTATO</label>
                                    <label class="flex items-center gap-2"><input type="checkbox" name="defect_type" value="phenolic" class="h-5 w-5 text-red-600"> PHENOLIC</label>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2 mt-4">
                            <textarea id="overall_final_notes" class="w-full p-2 border border-blue-200 rounded-md bg-white h-20 text-sm" placeholder="Notas finales..." oninput="updateNotes(this.id)"></textarea>
                        </div>
                    </section>
                </div>
            </div>
            
            <!-- Exportar PDF -->
            <div class="accordion-item bg-white rounded-lg shadow p-4 text-center">
                <h3 class="text-lg font-bold mb-2">Exportar Hoja de Cata Actual</h3>
                <button id="exportButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">
                    <i class="fas fa-file-pdf"></i> <span>Exportar PDF (Esta Muestra)</span>
                </button>
            </div>

        </main>
    </div>

    <!-- Footer Fijo con Puntuación -->
    <footer class="p-4 bg-blue-900 text-white shadow-inner grid grid-cols-3 gap-2 z-10">
        <div class="text-center">
            <span class="text-xs font-medium text-blue-200 block uppercase tracking-wider">Atributos</span>
            <span id="attribute_score_display" class="text-xl font-bold font-mono">0.00</span>
        </div>
        <div class="text-center border-l border-blue-700">
            <span class="text-xs font-medium text-blue-200 block uppercase tracking-wider">Defectos</span>
            <span id="defect_score_display" class="text-xl font-bold text-red-300 font-mono">0.00</span>
        </div>
        <div class="text-center border-l border-blue-700 bg-blue-800 rounded-lg mx-1 shadow-inner">
            <span class="text-xs font-medium text-blue-200 block uppercase tracking-wider mt-1">Total</span>
            <span id="total_score_display" class="text-2xl font-extrabold text-white font-mono">58.00</span>
        </div>
    </footer>

    <!-- Modal de Aromas -->
    <div id="aromaModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <header id="modalHeader" class="p-4 border-b flex justify-between items-center transition-colors duration-300 rounded-t-lg">
                <h2 id="modalTitle" class="text-xl font-bold">Select Aroma</h2>
                <button onclick="closeAromaModal()" class="text-2xl font-bold text-gray-600 hover:text-gray-900">&times;</button>
            </header>
            <div class="p-4 overflow-y-auto flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <div class="flex-1">
                    <h3 class="font-semibold mb-2 text-gray-500 uppercase text-xs tracking-wide">Nivel 2</h3>
                    <ul id="level2List" class="space-y-2"></ul>
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold mb-2 text-gray-500 uppercase text-xs tracking-wide">Nivel 3</h3>
                    <ul id="level3List" class="space-y-2"><li class="text-gray-400 text-sm italic">Seleccione Nivel 2</li></ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="limitMessage" class="hidden fixed bottom-24 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50 font-bold">Límite de 5 descriptores.</div>

    <script>
        // ==========================================
        // 1. DATOS Y CONFIGURACIÓN
        // ==========================================
        const aromaWheel = {
            'FLORAL': { btnColor: 'bg-pink-200', btnTextColor: 'text-pink-900', btnHover: 'hover:bg-pink-300', modalHeader: 'bg-pink-200', modalTitleColor: 'text-pink-900', modalBtnColor: 'bg-pink-50', modalBtnHover: 'hover:bg-pink-100', modalBtnText: 'text-pink-800', tagColor: 'bg-pink-200', tagTextColor: 'text-pink-900', sub: { 'Floral': ['Manzanilla', 'Rosa', 'Jazmín', 'Ninguno'], 'Té Negro': ['Té Negro', 'Ninguno'] } },
            'FRUITY': { btnColor: 'bg-red-200', btnTextColor: 'text-red-900', btnHover: 'hover:bg-red-300', modalHeader: 'bg-red-200', modalTitleColor: 'text-red-900', modalBtnColor: 'bg-red-50', modalBtnHover: 'hover:bg-red-100', modalBtnText: 'text-red-800', tagColor: 'bg-red-200', tagTextColor: 'text-red-900', sub: { 'Bayas': ['Mora', 'Frambuesa', 'Arándano', 'Fresa'], 'Fruta Seca': ['Pasa', 'Ciruela'], 'Cítrico': ['Naranja', 'Limón', 'Lima'], 'Otra Fruta': ['Coco', 'Cereza', 'Piña', 'Uva', 'Manzana', 'Durazno'] } },
            'SOUR/FERMENTED': { btnColor: 'bg-yellow-200', btnTextColor: 'text-yellow-900', btnHover: 'hover:bg-yellow-300', modalHeader: 'bg-yellow-200', modalTitleColor: 'text-yellow-900', modalBtnColor: 'bg-yellow-50', modalBtnHover: 'hover:bg-yellow-100', modalBtnText: 'text-yellow-800', tagColor: 'bg-yellow-200', tagTextColor: 'text-yellow-900', sub: { 'Agrio': ['Acético', 'Butírico', 'Isovalérico', 'Cítrico', 'Málico'], 'Fermentado': ['Alcohólico', 'Vinoso', 'Whisky', 'Sobre-maduro'] } },
            'GREEN/VEGETATIVE': { btnColor: 'bg-green-200', btnTextColor: 'text-green-900', btnHover: 'hover:bg-green-300', modalHeader: 'bg-green-200', modalTitleColor: 'text-green-900', modalBtnColor: 'bg-green-50', modalBtnHover: 'hover:bg-green-100', modalBtnText: 'text-green-800', tagColor: 'bg-green-200', tagTextColor: 'text-green-900', sub: { 'Aceite Oliva': ['Aceite'], 'Crudo': ['Crudo'], 'Verde': ['Pasto', 'Hierba', 'Heno'], 'Leguminoso': ['Leguminoso'] } },
            'OTHER': { btnColor: 'bg-purple-200', btnTextColor: 'text-purple-900', btnHover: 'hover:bg-purple-300', modalHeader: 'bg-purple-200', modalTitleColor: 'text-purple-900', modalBtnColor: 'bg-purple-50', modalBtnHover: 'hover:bg-purple-100', modalBtnText: 'text-purple-800', tagColor: 'bg-purple-200', tagTextColor: 'text-purple-900', sub: { 'Papel/Moho': ['Papel', 'Cartón', 'Moho', 'Tierra', 'Polvo'], 'Químico': ['Medicinal', 'Goma', 'Petróleo', 'Gas'] } },
            'ROASTED': { btnColor: 'bg-zinc-700', btnTextColor: 'text-zinc-50', btnHover: 'hover:bg-zinc-600', modalHeader: 'bg-zinc-700', modalTitleColor: 'text-zinc-50', modalBtnColor: 'bg-zinc-100', modalBtnHover: 'hover:bg-zinc-200', modalBtnText: 'text-zinc-800', tagColor: 'bg-zinc-700', tagTextColor: 'text-zinc-50', sub: { 'Cereal': ['Cereal'], 'Malta': ['Malta'], 'Tabaco': ['Tabaco'], 'Tostado': ['Quemado', 'Ahumado', 'Ceniza'] } },
            'NUTTY/COCOA': { btnColor: 'bg-orange-300', btnTextColor: 'text-orange-900', btnHover: 'hover:bg-orange-400', modalHeader: 'bg-orange-300', modalTitleColor: 'text-orange-900', modalBtnColor: 'bg-orange-50', modalBtnHover: 'hover:bg-orange-100', modalBtnText: 'text-orange-800', tagColor: 'bg-orange-300', tagTextColor: 'text-orange-900', sub: { 'Nuez': ['Maní', 'Avellana', 'Almendra'], 'Cacao': ['Chocolate', 'Choco Amargo'] } },
            'SPICY': { btnColor: 'bg-amber-500', btnTextColor: 'text-amber-50', btnHover: 'hover:bg-amber-600', modalHeader: 'bg-amber-500', modalTitleColor: 'text-amber-50', modalBtnColor: 'bg-amber-50', modalBtnHover: 'hover:bg-amber-100', modalBtnText: 'text-amber-800', tagColor: 'bg-amber-500', tagTextColor: 'text-amber-50', sub: { 'Especias': ['Anís', 'Nuez Moscada', 'Canela', 'Clavo', 'Pimienta'] } },
            'SWEET': { btnColor: 'bg-blue-200', btnTextColor: 'text-blue-900', btnHover: 'hover:bg-blue-300', modalHeader: 'bg-blue-200', modalTitleColor: 'text-blue-900', modalBtnColor: 'bg-blue-50', modalBtnHover: 'hover:bg-blue-100', modalBtnText: 'text-blue-800', tagColor: 'bg-blue-200', tagTextColor: 'text-blue-900', sub: { 'Vainilla': ['Vainilla'], 'Azúcar': ['Melaza', 'Caramelo', 'Miel'] } }
        };

        // Plantilla para una nueva sesión vacía
        const initialSessionState = {
            metadata: { nombre: "", fecha: "", cafe: "" },
            descriptive: { 
                fragrance_intensity: 7, aroma_intensity: 7, fragrance_aromas: [], 
                flavor_intensity: 7, aftertaste_intensity: 7, flavor_aromas: [], main_tastes: [],
                acidity_intensity: 7, acidity_type: null, 
                sweetness_intensity: 7, sweetness_notes: "", 
                mouthfeel_intensity: 7, mouthfeel_types: [], 
                part3_notes: "" 
            },
            affective: { 
                fragrance_final: 5, aroma_final: 5, flavor_final: 5, aftertaste_final: 5, 
                acidity_final: 5, sweetness_final: 5, mouthfeel_final: 5, overall_final: 5, 
                fragrance_aroma_final_notes: "", flavor_aftertaste_final_notes: "", 
                acidity_final_notes: "", sweetness_final_notes: "", 
                mouthfeel_final_notes: "", overall_final_notes: "",
                non_uniform_cups: 0, defective_cups: 0, defects: []
            }
        };

        // --- 2. ESTADO GLOBAL (SESIONES) ---
        let sessions = [];
        let activeSessionId = null;
        let modalState = { currentListKey: null, currentCategory: null };

        // Helper: Obtener la sesión activa
        function getActiveSession() {
            return sessions.find(s => s.id === activeSessionId);
        }

        // --- 3. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar acordeón
            document.querySelectorAll('.accordion-header').forEach(h => {
                h.addEventListener('click', () => {
                    h.classList.toggle('open');
                    h.nextElementSibling.classList.toggle('open');
                    const icon = h.querySelector('i');
                    icon.classList.toggle('fa-chevron-right');
                    icon.classList.toggle('fa-chevron-down');
                });
            });

            // Inicializar Aromas
            renderAromaGrid('fragrance_aroma_grid', 'fragrance_aromas');
            renderAromaGrid('flavor_aroma_grid', 'flavor_aromas');

            // Inicializar Sesiones
            initSessions();

            // Listeners Globales (Inputs)
            attachInputListeners();

            document.getElementById('exportButton').addEventListener('click', exportToPDF);

            // Registrar Service Worker
            if ('serviceWorker' in navigator && (window.location.protocol.startsWith('http'))) {
                navigator.serviceWorker.register('sw.js').catch(e => console.log(e));
            }
        });

        // --- 4. GESTIÓN DE SESIONES ---
        
        function initSessions() {
            // Crear primera sesión por defecto
            addSession(true);
        }

        function addSession(isFirst = false) {
            const id = Date.now();
            const newSession = JSON.parse(JSON.stringify(initialSessionState));
            newSession.id = id;
            
            // Si no es la primera, copiar Nombre y Fecha de la actual
            if (!isFirst) {
                const current = getActiveSession();
                if (current) {
                    newSession.metadata.nombre = current.metadata.nombre;
                    newSession.metadata.fecha = current.metadata.fecha;
                }
            } else {
                // Si es la primera, poner fecha de hoy
                newSession.metadata.fecha = new Date().toISOString().split('T')[0];
            }

            sessions.push(newSession);
            switchTab(id);
        }

        function switchTab(id) {
            activeSessionId = id;
            renderTabs();
            loadSessionDataToDOM(getActiveSession());
            calculateTotalScore();
        }

        function deleteSession(e, id) {
            e.stopPropagation(); // Detener propagación para no cambiar de tab
            if (sessions.length <= 1) {
                alert("Debe haber al menos una hoja de cata.");
                return;
            }
            if (!confirm("¿Borrar esta hoja de cata?")) return;

            const index = sessions.findIndex(s => s.id === id);
            sessions = sessions.filter(s => s.id !== id);

            // Si borramos la activa, cambiar a la anterior o a la 0
            if (id === activeSessionId) {
                const newIndex = Math.max(0, index - 1);
                switchTab(sessions[newIndex].id);
            } else {
                renderTabs(); // Solo redibujar tabs
            }
        }

        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';

            sessions.forEach((session, index) => {
                const isActive = session.id === activeSessionId;
                const name = session.metadata.cafe || `Muestra ${index + 1}`;

                const btn = document.createElement('div');
                btn.className = `flex items-center px-4 py-2 rounded-t-lg cursor-pointer whitespace-nowrap transition-colors border-r border-blue-700/30 relative group ${isActive ? 'bg-gray-50 text-blue-900 font-bold shadow-inner z-10' : 'bg-blue-900/40 text-blue-100 hover:bg-blue-800/60'}`;
                btn.onclick = () => switchTab(session.id);
                
                // Texto
                const span = document.createElement('span');
                span.textContent = name;
                span.className = "mr-2";
                btn.appendChild(span);

                // Botón Cerrar (si hay más de 1) - CORREGIDO TAMAÑO Y Z-INDEX
                if (sessions.length > 1) {
                    const closeBtn = document.createElement('button');
                    closeBtn.type = 'button';
                    closeBtn.innerHTML = '&times;';
                    // Aumentado w-6 h-6 y z-20 para asegurar clic
                    closeBtn.className = `w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-500 hover:text-white text-base font-bold opacity-70 hover:opacity-100 ml-2 transition z-20 bg-white/20`;
                    closeBtn.onclick = (e) => deleteSession(e, session.id);
                    btn.appendChild(closeBtn);
                }

                container.appendChild(btn);
            });

            // Botón Añadir (+)
            const addBtn = document.createElement('button');
            addBtn.className = "ml-1 mb-1 p-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow w-8 h-8 flex items-center justify-center transition-transform active:scale-95 shrink-0";
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.onclick = () => addSession();
            container.appendChild(addBtn);
        }

        // --- 5. SINCRONIZACIÓN DATOS <-> DOM ---

        function loadSessionDataToDOM(session) {
            const d = session.descriptive;
            const a = session.affective;
            const m = session.metadata;

            // Metadata
            document.getElementById('catador_nombre').value = m.nombre;
            document.getElementById('catador_fecha').value = m.fecha;
            document.getElementById('catador_cafe').value = m.cafe;

            // Sliders & Displays
            ['fragrance_intensity', 'aroma_intensity', 'flavor_intensity', 'aftertaste_intensity', 
             'acidity_intensity', 'sweetness_intensity', 'mouthfeel_intensity'].forEach(k => {
                document.getElementById(k).value = d[k];
                document.getElementById(k + '_val').textContent = d[k];
            });
            ['fragrance_final', 'aroma_final', 'flavor_final', 'aftertaste_final', 
             'acidity_final', 'sweetness_final', 'mouthfeel_final', 'overall_final'].forEach(k => {
                document.getElementById(k).value = a[k];
                // El ID del span de valor suele ser k + '_val'
                const valSpan = document.getElementById(k + '_val');
                if(valSpan) valSpan.textContent = a[k];
            });

            // Notes
            document.getElementById('sweetness_notes').value = d.sweetness_notes;
            document.getElementById('part3_notes').value = d.part3_notes;
            ['fragrance_aroma', 'flavor_aftertaste', 'acidity', 'sweetness', 'mouthfeel', 'overall'].forEach(k => {
                document.getElementById(k + '_final_notes').value = a[k + '_final_notes'];
            });

            // Checkboxes & Radios
            // Acidity Radio
            const radios = document.getElementsByName('acidity_type');
            radios.forEach(r => r.checked = (r.value === d.acidity_type));

            // Arrays (Main Tastes, Mouthfeel, Defects)
            // Reset checkboxes first
            document.querySelectorAll('input[name="main_taste"]').forEach(cb => cb.checked = d.main_tastes.includes(cb.value));
            document.querySelectorAll('input[name="mouthfeel_type"]').forEach(cb => cb.checked = d.mouthfeel_types.includes(cb.value));
            document.querySelectorAll('input[name="defect_type"]').forEach(cb => cb.checked = a.defects.includes(cb.value));
            
            // Count Checkboxes (Non-Uniform, Defective)
            const nonUniInputs = document.querySelectorAll('input[name="non_uniform_cups"]');
            nonUniInputs.forEach((cb, i) => cb.checked = i < a.non_uniform_cups);

            const defCupsInputs = document.querySelectorAll('input[name="defective_cups"]');
            defCupsInputs.forEach((cb, i) => cb.checked = i < a.defective_cups);

            // Aromas (Re-render tags)
            renderTags('fragrance_aromas');
            renderTags('flavor_aromas');
        }

        function attachInputListeners() {
            // Metadata
            ['catador_nombre', 'catador_fecha'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => getActiveSession().metadata[id.split('_')[1]] = e.target.value);
            });
            // Cafe (Special: updates tab name)
            document.getElementById('catador_cafe').addEventListener('input', (e) => {
                getActiveSession().metadata.cafe = e.target.value;
                renderTabs(); // Redraw tabs to show new name
            });

            // Notes
            const noteIds = ['sweetness_notes', 'part3_notes', 'fragrance_aroma_final_notes', 'flavor_aftertaste_final_notes', 'acidity_final_notes', 'sweetness_final_notes', 'mouthfeel_final_notes', 'overall_final_notes'];
            noteIds.forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => updateNotes(id, e.target.value));
            });

            // Checkboxes (Simple Lists)
            document.querySelectorAll('input[name="main_taste"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const s = getActiveSession().descriptive;
                    if(cb.checked) s.main_tastes.push(cb.value);
                    else s.main_tastes = s.main_tastes.filter(x => x !== cb.value);
                });
            });
            document.querySelectorAll('input[name="mouthfeel_type"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const s = getActiveSession().descriptive;
                    if(cb.checked) s.mouthfeel_types.push(cb.value);
                    else s.mouthfeel_types = s.mouthfeel_types.filter(x => x !== cb.value);
                });
            });
            document.querySelectorAll('input[name="defect_type"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const s = getActiveSession().affective;
                    if(cb.checked) s.defects.push(cb.value);
                    else s.defects = s.defects.filter(x => x !== cb.value);
                });
            });

            // Radios
            document.querySelectorAll('input[name="acidity_type"]').forEach(rb => {
                rb.addEventListener('change', () => {
                    if(rb.checked) getActiveSession().descriptive.acidity_type = rb.value;
                });
            });

            // Count Checkboxes
            document.querySelectorAll('input[name="non_uniform_cups"]').forEach(cb => cb.addEventListener('change', () => {
                getActiveSession().affective.non_uniform_cups = document.querySelectorAll('input[name="non_uniform_cups"]:checked').length; calculateTotalScore();
            }));
            document.querySelectorAll('input[name="defective_cups"]').forEach(cb => cb.addEventListener('change', () => {
                getActiveSession().affective.defective_cups = document.querySelectorAll('input[name="defective_cups"]:checked').length; calculateTotalScore();
            }));
        }


        // --- 6. FUNCIONES AUXILIARES ---
        function updateSlider(id) {
            const val = document.getElementById(id).value;
            document.getElementById(id + '_val').textContent = val;
            
            const session = getActiveSession();
            const section = id.includes('_final') ? 'affective' : 'descriptive';
            session[section][id] = parseInt(val);
            
            if (section === 'affective') calculateTotalScore();
        }

        function updateNotes(id, val) {
            const session = getActiveSession();
            if (id.includes('_final_') || id === 'overall_final_notes') {
                session.affective[id] = val;
            } else {
                session.descriptive[id] = val;
            }
        }

        const SLIDER_PTS = { '1': 0, '2': 0.75, '3': 1.25, '4': 2, '5': 2.75, '6': 3.25, '7': 4, '8': 4.5, '9': 5.25 };
        
        function calculateTotalScore() {
            const s = getActiveSession().affective;
            let score = 0;
            ['fragrance_final', 'aroma_final', 'flavor_final', 'aftertaste_final', 'acidity_final', 'sweetness_final', 'mouthfeel_final', 'overall_final'].forEach(k => {
                score += SLIDER_PTS[String(s[k] || '1')];
            });
            const defects = (s.non_uniform_cups * 2) + (s.defective_cups * 4);
            const total = 58.00 + score - defects;
            
            document.getElementById('attribute_score_display').textContent = score.toFixed(2);
            document.getElementById('defect_score_display').textContent = `-${defects.toFixed(2)}`;
            document.getElementById('total_score_display').textContent = total.toFixed(2);
        }

        // Aromas
        function renderAromaGrid(cid, listKey) {
            const c = document.getElementById(cid); c.innerHTML = '';
            for(let cat in aromaWheel) {
                const b = document.createElement('button'); b.textContent = cat;
                b.className = `p-3 rounded-lg font-semibold transition h-full ${aromaWheel[cat].btnColor} ${aromaWheel[cat].btnTextColor} ${aromaWheel[cat].btnHover}`;
                b.onclick = () => openAromaModal(cat, listKey);
                c.appendChild(b);
            }
        }
        function openAromaModal(cat, listKey) {
            const list = getActiveSession().descriptive[listKey];
            if(list.length >= 5) return document.getElementById('limitMessage').classList.remove('hidden'), setTimeout(()=>document.getElementById('limitMessage').classList.add('hidden'), 2000);
            
            modalState = { currentListKey: listKey, currentCategory: cat };
            const d = aromaWheel[cat];
            const mh = document.getElementById('modalHeader'); mh.className = `p-4 border-b flex justify-between items-center ${d.modalHeader}`;
            document.getElementById('modalTitle').className = `text-xl font-bold ${d.modalTitleColor}`;
            document.getElementById('modalTitle').textContent = `Seleccionar: ${cat}`;
            const l2 = document.getElementById('level2List'); l2.innerHTML = '';
            document.getElementById('level3List').innerHTML = '<li class="text-gray-400">Seleccione Nivel 2</li>';
            
            for(let sub in d.sub) {
                const li = document.createElement('li'); li.textContent = sub;
                li.className = `p-3 rounded-md cursor-pointer ${d.modalBtnColor} ${d.modalBtnText} ${d.modalBtnHover}`;
                li.onclick = () => {
                    const l3 = document.getElementById('level3List'); l3.innerHTML = '';
                    d.sub[sub].forEach(item => {
                        const li3 = document.createElement('li'); li3.textContent = item;
                        li3.className = li.className;
                        li3.onclick = () => {
                            getActiveSession().descriptive[listKey].push({text: `${cat} > ${sub} > ${item}`, category: cat});
                            renderTags(listKey); closeAromaModal();
                        };
                        l3.appendChild(li3);
                    });
                };
                l2.appendChild(li);
            }
            document.getElementById('aromaModal').classList.remove('hidden');
        }
        function closeAromaModal() { document.getElementById('aromaModal').classList.add('hidden'); }
        
        function renderTags(listKey) {
            const c = document.getElementById(listKey === 'fragrance_aromas' ? 'fragrance_aroma_tags' : 'flavor_aroma_tags'); 
            c.innerHTML = '';
            // Usamos la sesión activa
            const list = getActiveSession().descriptive[listKey];
            list.forEach(obj => {
                const d = aromaWheel[obj.category];
                const t = document.createElement('div'); t.className = `aroma-tag ${d.tagColor} ${d.tagTextColor}`;
                t.innerHTML = `<span class="aroma-tag-text">${obj.text}</span><button onclick="removeAroma('${listKey}', '${obj.text.replace(/'/g,"\\'")}')">&times;</button>`;
                c.appendChild(t);
            });
        }
        function removeAroma(listKey, txt) {
            const session = getActiveSession();
            session.descriptive[listKey] = session.descriptive[listKey].filter(x => x.text !== txt); 
            renderTags(listKey);
        }

        // PDF Export (Usando datos de la sesión ACTIVA)
        async function exportToPDF() {
            const btn = document.getElementById('exportButton'); const oldTxt = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'Generando...';
            
            const current = getActiveSession();
            const { nombre, cafe, fecha } = current.metadata;
            const filename = `${(nombre||'catador').replace(/\W/g,'_')}_${(cafe||'muestra').replace(/\W/g,'_')}_${fecha}.pdf`;
            
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
            const items = document.querySelectorAll('.accordion-item');
            
            for(let i=0; i<items.length; i++) {
                if(items[i].contains(btn)) continue; 
                
                const content = items[i].querySelector('.accordion-content');
                const wasOpen = content.classList.contains('open');
                if(!wasOpen) { content.classList.add('open'); content.style.maxHeight = 'none'; }
                
                await new Promise(r => setTimeout(r, 100)); 
                
                const canvas = await html2canvas(items[i], { scale: 2, backgroundColor: '#ffffff' });
                const img = canvas.toDataURL('image/png');
                const h = (canvas.height * 210) / canvas.width; 
                
                if(i > 0) doc.addPage();
                doc.addImage(img, 'PNG', 0, 10, 210, h);
                
                if(!wasOpen) { content.classList.remove('open'); content.style.maxHeight = ''; }
            }
            
            doc.save(filename);
            btn.disabled = false; btn.innerHTML = oldTxt;
        }
    </script>
</body>
</html>
