import React, { useState, useMemo, useRef, useEffect } from 'react';
import { FileDown, Loader2, Plus, X, ChevronDown, ArrowLeft } from 'lucide-react';

// --- CONSTANTS & DATA ---

const SLIDER_POINTS = {
  '1': 0.00, '2': 0.75, '3': 1.25, '4': 2.00, '5': 2.75,
  '6': 3.25, '7': 4.00, '8': 4.50, '9': 5.25
};

const INITIAL_STATE = {
  metadata: { nombre: "", fecha: new Date().toISOString().split('T')[0], cafe: "" },
  descriptive: {
    fragrance_intensity: 7, aroma_intensity: 7, fragrance_aromas: [],
    flavor_intensity: 7, aftertaste_intensity: 7, flavor_aromas: [], main_tastes: [],
    acidity_intensity: 7, acidity_type: null,
    sweetness_intensity: 7, sweetness_notes: "",
    mouthfeel_intensity: 7, mouthfeel_types: [],
    part3_notes: ""
  },
  affective: {
    fragrance_final: 5, aroma_final: 5, flavor_final: 5, aftertaste_final: 5,
    acidity_final: 5, sweetness_final: 5, mouthfeel_final: 5, overall_final: 5,
    fragrance_aroma_final_notes: "", flavor_aftertaste_final_notes: "",
    acidity_final_notes: "", sweetness_final_notes: "",
    mouthfeel_final_notes: "", overall_final_notes: "",
    non_uniform_cups: 0, defective_cups: 0, defects: []
  }
};

// Colores oficiales y estructura COMPLETA de la SCA
const AROMA_WHEEL = {
    'FLORAL': {
        color: '#db2d83', text: 'white',
        sub: { 
            'Floral': ['Manzanilla', 'Rosa', 'Jazmín'], 
            'Té Negro': ['Té Negro'] 
        }
    },
    'FRUITY': {
        color: '#da2e34', text: 'white',
        sub: { 
            'Bayas (Berry)': ['Mora', 'Frambuesa', 'Arándano', 'Fresa'], 
            'Fruta Seca': ['Pasa', 'Ciruela Pasa'], 
            'Cítrico': ['Pomelo', 'Naranja', 'Limón', 'Lima'], 
            'Otra Fruta': ['Coco', 'Cereza', 'Granada', 'Piña', 'Uva', 'Manzana', 'Melocotón', 'Pera'] 
        }
    },
    'SOUR/FERMENTED': {
        color: '#e5ba26', text: 'black',
        sub: { 
            'Agrio (Sour)': ['Acético', 'Butírico', 'Isovalérico', 'Cítrico', 'Málico'], 
            'Alcohol/Ferm': ['Vinoso', 'Whisky', 'Fermentado', 'Sobre-maduro'] 
        }
    },
    'GREEN/VEGETATIVE': {
        color: '#227933', text: 'white',
        sub: { 
            'Aceite de Oliva': ['Aceite de Oliva'], 
            'Crudo': ['Crudo'], 
            'Verde/Veg': ['Poco tostado', 'Guisante', 'Fresco', 'Verde oscuro', 'Vegetativo', 'Heno', 'Herbáceo'], 
            'Leguminoso': ['Leguminoso'] 
        }
    },
    'OTHER': {
        color: '#209ebb', text: 'white',
        sub: { 
            'Papel/Moho': ['Viejo', 'Papel', 'Cartón', 'Moho', 'Tierra', 'Polvo', 'Madera'], 
            'Químico': ['Amargo', 'Salado', 'Medicinal', 'Petróleo', 'Gas', 'Caucho'] 
        }
    },
    'ROASTED': {
        color: '#b2432d', text: 'white',
        sub: { 
            'Cereal': ['Cereal', 'Grano', 'Malta'], 
            'Tabaco': ['Tabaco', 'Tabaco Pipa'], 
            'Tostado': ['Quemado', 'Acre', 'Ceniza', 'Ahumado', 'Tostado'] 
        }
    },
    'SPICES': {
        color: '#a41f36', text: 'white',
        sub: {
            'Especias Marrones': ['Clavo', 'Canela', 'Nuez Moscada', 'Anís'],
            'Pimienta': ['Pimienta'],
            'Picante': ['Picante']
        }
    },
    'NUTTY/COCOA': {
        color: '#a16848', text: 'white',
        sub: { 
            'Nuez': ['Maní', 'Avellana', 'Almendra'], 
            'Cacao': ['Chocolate', 'Choco Amargo'] 
        }
    },
    'SWEET': {
        color: '#e66a28', text: 'white',
        sub: { 
            'Azúcar Morena': ['Melaza', 'Sirope de Arce', 'Caramelizado', 'Miel'],
            'Vainilla': ['Vainilla'],
            'Aromáticos Dulces': ['Vanillina'],
            'Dulce General': ['Dulce']
        }
    }
};

// --- COMPONENTS ---

// Componente de Rueda Interactiva SVG
const InteractiveWheel = ({ onSelect, onCancel }) => {
    const [path, setPath] = useState([]); // [] = root, ['FRUITY'] = level 2
    
    const segments = useMemo(() => {
        if (path.length === 0) {
            // Nivel 0: Categorías Principales
            return Object.keys(AROMA_WHEEL).map(key => ({
                label: key,
                color: AROMA_WHEEL[key].color,
                textColor: AROMA_WHEEL[key].text,
                value: key,
                isLeaf: false
            }));
        } else if (path.length === 1) {
            // Nivel 1: Subcategorías (Segundo Anillo)
            const catKey = path[0];
            const subCats = AROMA_WHEEL[catKey].sub;
            
            return Object.keys(subCats).map(key => {
                const subItems = subCats[key];
                // DETECCIÓN INTELIGENTE:
                // Si el array de hijos tiene 1 solo elemento y se llama igual que el padre (o similar),
                // lo consideramos un "nodo hoja" en este nivel.
                const isTerminal = subItems.length === 1 && subItems[0] === key;

                return {
                    label: key,
                    color: AROMA_WHEEL[catKey].color,
                    textColor: AROMA_WHEEL[catKey].text,
                    value: key,
                    isLeaf: isTerminal // Si es true, al hacer click SELECCIONA en vez de entrar
                };
            });
        } else if (path.length === 2) {
            // Nivel 2: Items finales (Tercer Anillo real)
            const catKey = path[0];
            const subKey = path[1];
            const items = AROMA_WHEEL[catKey].sub[subKey];
            return items.map(item => ({
                label: item,
                color: AROMA_WHEEL[catKey].color,
                textColor: AROMA_WHEEL[catKey].text,
                value: item,
                isLeaf: true
            }));
        }
        return [];
    }, [path]);

    const handleSegmentClick = (segment) => {
        if (segment.isLeaf) {
            // Es un final (sea anillo 2 o 3), seleccionamos
            const fullText = [...path, segment.value].join(' > ');
            onSelect(fullText, path[0]); 
        } else {
            // No es final, profundizamos (zoom)
            setPath([...path, segment.value]);
        }
    };

    const handleBack = () => {
        setPath(path.slice(0, -1));
    };

    const size = 300;
    const center = size / 2;
    const radius = size / 2 - 10;
    const innerRadius = 40;

    const createArc = (index, total, label, color, textColor, onClick) => {
        const startAngle = (index * 360) / total;
        const endAngle = ((index + 1) * 360) / total;
        
        const startRad = (startAngle - 90) * (Math.PI / 180);
        const endRad = (endAngle - 90) * (Math.PI / 180);

        const x1 = center + radius * Math.cos(startRad);
        const y1 = center + radius * Math.sin(startRad);
        const x2 = center + radius * Math.cos(endRad);
        const y2 = center + radius * Math.sin(endRad);

        const x1_inner = center + innerRadius * Math.cos(startRad);
        const y1_inner = center + innerRadius * Math.sin(startRad);
        const x2_inner = center + innerRadius * Math.cos(endRad);
        const y2_inner = center + innerRadius * Math.sin(endRad);

        const largeArc = endAngle - startAngle > 180 ? 1 : 0;

        const d = [
            `M ${x1_inner} ${y1_inner}`,
            `L ${x1} ${y1}`,
            `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
            `L ${x2_inner} ${y2_inner}`,
            `A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${x1_inner} ${y1_inner}`,
            `Z`
        ].join(" ");

        const midAngle = (startAngle + endAngle) / 2 - 90;
        const midRad = midAngle * (Math.PI / 180);
        const textRadius = innerRadius + (radius - innerRadius) * 0.6;
        const textX = center + textRadius * Math.cos(midRad);
        const textY = center + textRadius * Math.sin(midRad);

        let rotation = midAngle + 90;
        if (rotation > 90 && rotation < 270) rotation += 180;

        return (
            <g key={index} onClick={onClick} style={{ cursor: 'pointer' }} className="hover:opacity-90 transition-opacity">
                <path d={d} fill={color} stroke="white" strokeWidth="2" />
                <text 
                    x={textX} 
                    y={textY} 
                    fill={textColor} 
                    fontSize="10" 
                    fontWeight="bold"
                    textAnchor="middle" 
                    alignmentBaseline="middle"
                    transform={`rotate(${rotation}, ${textX}, ${textY})`}
                    style={{ pointerEvents: 'none', textShadow: '0px 0px 2px rgba(0,0,0,0.5)' }}
                >
                    {label.length > 12 ? label.substring(0, 10) + '..' : label}
                </text>
            </g>
        );
    };

    return (
        <div className="flex flex-col items-center justify-center h-full">
            <div className="relative w-[300px] h-[300px]">
                <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
                    {segments.map((seg, i) => 
                        createArc(i, segments.length, seg.label, seg.color, seg.textColor, () => handleSegmentClick(seg))
                    )}
                    <circle cx={center} cy={center} r={innerRadius - 2} fill="white" stroke="#ddd" strokeWidth="1" />
                </svg>
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    {path.length > 0 ? (
                        <button 
                            onClick={handleBack}
                            className="pointer-events-auto w-16 h-16 rounded-full flex items-center justify-center bg-white shadow-md hover:bg-gray-100 text-gray-600 transition-colors"
                        >
                            <ArrowLeft size={24} />
                        </button>
                    ) : (
                        <div className="text-xs font-bold text-gray-400 text-center w-16">SCA<br/>WHEEL</div>
                    )}
                </div>
            </div>
            
            <div className="mt-6 text-center">
                <p className="text-sm text-gray-500 mb-2">
                    {path.length === 0 ? "Selecciona una Categoría" : path.join(" > ")}
                </p>
                <button onClick={onCancel} className="text-red-500 text-sm underline">Cancelar</button>
            </div>
        </div>
    );
};

// --- HELPER FUNCTIONS ---

const getFreshState = () => JSON.parse(JSON.stringify(INITIAL_STATE));

// Load scripts dynamically
const loadScript = (src) => {
    return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
            resolve();
            return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
};

const generatePDF = async (data, containerRef, setIsExporting) => {
    if (!containerRef.current) return;
    setIsExporting(true);

    try {
        // Load Libraries
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

        const { nombre, cafe, fecha } = data.metadata;
        const filename = `${nombre || 'catador'}_${cafe || 'cafe'}_${fecha || 'fecha'}.pdf`.replace(/[^a-z0-9_.-]/gi, '_');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210; 

        const sections = containerRef.current.querySelectorAll('.accordion-item-container');
        let pageAdded = false;

        for (let i = 0; i < sections.length; i++) {
            const section = sections[i];
            const content = section.querySelector('.accordion-content');
            
            const originalMaxHeight = content.style.maxHeight;
            const originalOpacity = content.style.opacity;

            content.style.maxHeight = 'none';
            content.style.opacity = '1';
            content.style.display = 'block'; 
            
            await new Promise(r => setTimeout(r, 100));

            const canvas = await window.html2canvas(section, { scale: 2, backgroundColor: '#ffffff' });
            const imgData = canvas.toDataURL('image/png');
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            if (pageAdded) doc.addPage();
            doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            pageAdded = true;

            content.style.maxHeight = originalMaxHeight;
            content.style.opacity = originalOpacity;
            content.style.display = '';
        }
        
        doc.save(filename);

    } catch (error) {
        console.error("Export failed", error);
        alert("Error generating PDF");
    } finally {
        setIsExporting(false);
    }
};

// --- COMPONENTS ---

const SliderControl = ({ label, value, onChange, min = 0, max = 15, className = "" }) => (
    <div className={`space-y-1 ${className}`}>
        <div className="flex justify-between items-center text-sm font-medium text-gray-700">
            <span>{label}</span>
            <span className="text-blue-600 font-bold">{value}</span>
        </div>
        <input 
            type="range" min={min} max={max} value={value} 
            onChange={(e) => onChange(Number(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
        />
    </div>
);

const TextAreaControl = ({ label, value, onChange, placeholder, height = "h-24" }) => (
    <div className="space-y-1">
        {label && <label className="text-sm font-medium text-gray-700">{label}</label>}
        <textarea 
            value={value} onChange={(e) => onChange(e.target.value)}
            className={`w-full p-2 border border-gray-300 rounded-md bg-white ${height} text-sm`}
            placeholder={placeholder}
        />
    </div>
);

const AccordionItem = ({ title, children, defaultOpen = false }) => {
    const [isOpen, setIsOpen] = useState(defaultOpen);
    return (
        <div className="accordion-item-container bg-white rounded-lg shadow overflow-hidden border border-gray-100">
            <button 
                onClick={() => setIsOpen(!isOpen)}
                className="accordion-header w-full flex justify-between items-center p-4 text-left hover:bg-gray-50 transition-colors"
            >
                <h2 className="text-lg font-semibold text-gray-800">{title}</h2>
                <div style={{ transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}>
                    <ChevronDown size={20} className="text-gray-400" />
                </div>
            </button>
            <div className={`accordion-content transition-all duration-300 ease-in-out ${isOpen ? 'max-h-[2000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                <div className="p-4 pt-0 border-t border-gray-100">
                    {children}
                </div>
            </div>
        </div>
    );
};

const AromaTag = ({ text, category, onRemove }) => {
    const colors = AROMA_WHEEL[category] || { color: '#ccc', text: 'black' };
    return (
        <span 
            className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium m-1"
            style={{ backgroundColor: colors.color, color: colors.text }}
        >
            {text}
            <button onClick={onRemove} className="ml-2 opacity-60 hover:opacity-100">
                <X size={12} />
            </button>
        </span>
    );
};

// --- SECTIONS ---

const MetadataSection = ({ data, onChange }) => {
    const handleChange = (field, value) => {
        onChange(prev => ({ ...prev, metadata: { ...prev.metadata, [field]: value } }));
    };
    return (
        <div className="space-y-3 mt-2">
            <div>
                <label className="block text-xs font-medium text-gray-500 uppercase">Name</label>
                <input 
                    type="text" value={data.metadata.nombre} 
                    onChange={e => handleChange('nombre', e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded mt-1"
                />
            </div>
            <div>
                <label className="block text-xs font-medium text-gray-500 uppercase">Date</label>
                <input 
                    type="date" value={data.metadata.fecha} 
                    onChange={e => handleChange('fecha', e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded mt-1"
                />
            </div>
            <div>
                <label className="block text-xs font-medium text-gray-500 uppercase">Sample / Coffee</label>
                <input 
                    type="text" value={data.metadata.cafe} 
                    onChange={e => handleChange('cafe', e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded mt-1"
                    placeholder="Sample ID"
                />
            </div>
        </div>
    );
};

const FragranceSection = ({ data, onChange, openAromaModal }) => {
    const updateDesc = (k, v) => onChange(prev => ({ ...prev, descriptive: { ...prev.descriptive, [k]: v } }));
    const updateAff = (k, v) => onChange(prev => ({ ...prev, affective: { ...prev.affective, [k]: v } }));
    
    return (
        <div className="space-y-6 mt-2">
            <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3">Descriptive</h3>
                <SliderControl label="Fragrance Intensity" value={data.descriptive.fragrance_intensity} onChange={v => updateDesc('fragrance_intensity', v)} />
                <SliderControl label="Aroma Intensity" value={data.descriptive.aroma_intensity} onChange={v => updateDesc('aroma_intensity', v)} className="mt-4" />
                
                <div className="mt-4">
                    <p className="text-xs font-medium text-gray-500 mb-2">AROMAS (Select up to 5)</p>
                    <div className="flex flex-wrap -m-1 mb-2 min-h-[2rem]">
                        {data.descriptive.fragrance_aromas.map((a, i) => (
                            <AromaTag key={i} text={a.text} category={a.category} 
                                onRemove={() => updateDesc('fragrance_aromas', data.descriptive.fragrance_aromas.filter((_, idx) => idx !== i))} 
                            />
                        ))}
                    </div>
                    <button 
                        onClick={() => openAromaModal('fragrance_aromas')}
                        className="w-full py-2 mt-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow hover:bg-blue-700 flex items-center justify-center gap-2"
                    >
                        <Plus size={16} /> Abrir Rueda de Aromas
                    </button>
                </div>
            </div>
            
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 className="text-sm font-bold text-blue-800 uppercase mb-3">Affective Score</h3>
                <SliderControl label="Fragrance Score" value={data.affective.fragrance_final} onChange={v => updateAff('fragrance_final', v)} min={1} max={9} />
                <SliderControl label="Aroma Score" value={data.affective.aroma_final} onChange={v => updateAff('aroma_final', v)} min={1} max={9} className="mt-4" />
                <div className="mt-4">
                    <TextAreaControl placeholder="Notes..." value={data.affective.fragrance_aroma_final_notes} onChange={v => updateAff('fragrance_aroma_final_notes', v)} />
                </div>
            </div>
        </div>
    );
};

const FlavorSection = ({ data, onChange, openAromaModal }) => {
    const updateDesc = (k, v) => onChange(prev => ({ ...prev, descriptive: { ...prev.descriptive, [k]: v } }));
    const updateAff = (k, v) => onChange(prev => ({ ...prev, affective: { ...prev.affective, [k]: v } }));
    const tastes = ['Salty', 'Sour', 'Sweet', 'Bitter', 'Umami'];
    
    return (
        <div className="space-y-6 mt-2">
            <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3">Descriptive</h3>
                <SliderControl label="Flavor Intensity" value={data.descriptive.flavor_intensity} onChange={v => updateDesc('flavor_intensity', v)} />
                <SliderControl label="Aftertaste Intensity" value={data.descriptive.aftertaste_intensity} onChange={v => updateDesc('aftertaste_intensity', v)} className="mt-4" />
                
                <div className="mt-4">
                    <p className="text-xs font-medium text-gray-500 mb-2">FLAVORS (Select up to 5)</p>
                    <div className="flex flex-wrap -m-1 mb-2 min-h-[2rem]">
                        {data.descriptive.flavor_aromas.map((a, i) => (
                            <AromaTag key={i} text={a.text} category={a.category} 
                                onRemove={() => updateDesc('flavor_aromas', data.descriptive.flavor_aromas.filter((_, idx) => idx !== i))} 
                            />
                        ))}
                    </div>
                    <button 
                        onClick={() => openAromaModal('flavor_aromas')}
                        className="w-full py-2 mt-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow hover:bg-blue-700 flex items-center justify-center gap-2"
                    >
                        <Plus size={16} /> Abrir Rueda de Sabores
                    </button>
                </div>

                 <div className="mt-4">
                    <p className="text-xs font-medium text-gray-500 mb-2">MAIN TASTES</p>
                    <div className="flex flex-wrap gap-2">
                        {tastes.map(t => (
                            <label key={t} className="flex items-center space-x-1 text-sm bg-white px-2 py-1 rounded border border-gray-200">
                                <input type="checkbox" checked={data.descriptive.main_tastes.includes(t)}
                                    onChange={e => {
                                        const curr = data.descriptive.main_tastes;
                                        const next = e.target.checked ? [...curr, t] : curr.filter(x => x !== t);
                                        updateDesc('main_tastes', next);
                                    }}
                                    className="rounded text-blue-600"
                                />
                                <span>{t}</span>
                            </label>
                        ))}
                    </div>
                </div>
            </div>
            
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 className="text-sm font-bold text-blue-800 uppercase mb-3">Affective Score</h3>
                <SliderControl label="Flavor Score" value={data.affective.flavor_final} onChange={v => updateAff('flavor_final', v)} min={1} max={9} />
                <SliderControl label="Aftertaste Score" value={data.affective.aftertaste_final} onChange={v => updateAff('aftertaste_final', v)} min={1} max={9} className="mt-4" />
                <div className="mt-4">
                    <TextAreaControl placeholder="Notes..." value={data.affective.flavor_aftertaste_final_notes} onChange={v => updateAff('flavor_aftertaste_final_notes', v)} />
                </div>
            </div>
        </div>
    );
};

const AciditySection = ({ data, onChange }) => {
    const updateDesc = (k, v) => onChange(prev => ({ ...prev, descriptive: { ...prev.descriptive, [k]: v } }));
    const updateAff = (k, v) => onChange(prev => ({ ...prev, affective: { ...prev.affective, [k]: v } }));
    
    return (
        <div className="space-y-6 mt-2">
            <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3">Descriptive</h3>
                <SliderControl label="Acidity Intensity" value={data.descriptive.acidity_intensity} onChange={v => updateDesc('acidity_intensity', v)} />
                <div className="mt-4 flex space-x-4">
                    {['Dry', 'Sweet'].map(type => (
                        <label key={type} className="flex items-center space-x-2 text-sm cursor-pointer">
                            <input type="radio" name="acidityType" value={type} checked={data.descriptive.acidity_type === type}
                                onChange={() => updateDesc('acidity_type', type)} className="text-blue-600" />
                            <span>{type}</span>
                        </label>
                    ))}
                </div>
            </div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 className="text-sm font-bold text-blue-800 uppercase mb-3">Affective Score</h3>
                <SliderControl label="Acidity Score" value={data.affective.acidity_final} onChange={v => updateAff('acidity_final', v)} min={1} max={9} />
                 <div className="mt-4">
                    <TextAreaControl placeholder="Notes..." value={data.affective.acidity_final_notes} onChange={v => updateAff('acidity_final_notes', v)} />
                </div>
            </div>
        </div>
    );
};

const SweetnessSection = ({ data, onChange }) => {
    const updateDesc = (k, v) => onChange(prev => ({ ...prev, descriptive: { ...prev.descriptive, [k]: v } }));
    const updateAff = (k, v) => onChange(prev => ({ ...prev, affective: { ...prev.affective, [k]: v } }));
    return (
        <div className="space-y-6 mt-2">
            <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3">Descriptive</h3>
                <SliderControl label="Sweetness Intensity" value={data.descriptive.sweetness_intensity} onChange={v => updateDesc('sweetness_intensity', v)} />
                <div className="mt-4">
                     <TextAreaControl label="Descriptor Notes" placeholder="Honey-like, Caramel..." value={data.descriptive.sweetness_notes} onChange={v => updateDesc('sweetness_notes', v)} height="h-16" />
                </div>
            </div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 className="text-sm font-bold text-blue-800 uppercase mb-3">Affective Score</h3>
                <SliderControl label="Sweetness Score" value={data.affective.sweetness_final} onChange={v => updateAff('sweetness_final', v)} min={1} max={9} />
                 <div className="mt-4">
                    <TextAreaControl placeholder="Notes..." value={data.affective.sweetness_final_notes} onChange={v => updateAff('sweetness_final_notes', v)} />
                </div>
            </div>
        </div>
    );
};

const MouthfeelSection = ({ data, onChange }) => {
    const updateDesc = (k, v) => onChange(prev => ({ ...prev, descriptive: { ...prev.descriptive, [k]: v } }));
    const updateAff = (k, v) => onChange(prev => ({ ...prev, affective: { ...prev.affective, [k]: v } }));
    const types = ['Rough', 'Oily', 'Smooth', 'Drying', 'Metallic'];
    
    return (
        <div className="space-y-6 mt-2">
             <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3">Descriptive</h3>
                <SliderControl label="Mouthfeel Intensity" value={data.descriptive.mouthfeel_intensity} onChange={v => updateDesc('mouthfeel_intensity', v)} />
                 <div className="mt-4 grid grid-cols-2 gap-2">
                    {types.map(t => (
                        <label key={t} className="flex items-center space-x-1 text-sm">
                            <input type="checkbox" checked={data.descriptive.mouthfeel_types.includes(t)}
                                onChange={e => {
                                    const curr = data.descriptive.mouthfeel_types;
                                    const next = e.target.checked ? [...curr, t] : curr.filter(x => x !== t);
                                    updateDesc('mouthfeel_types', next);
                                }}
                                className="rounded text-blue-600"
                            />
                            <span>{t}</span>
                        </label>
                    ))}
                </div>
            </div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 className="text-sm font-bold text-blue-800 uppercase mb-3">Affective Score</h3>
                <SliderControl label="Mouthfeel Score" value={data.affective.mouthfeel_final} onChange={v => updateAff('mouthfeel_final', v)} min={1} max={9} />
                 <div className="mt-4">
                    <TextAreaControl placeholder="Notes..." value={data.affective.mouthfeel_final_notes} onChange={v => updateAff('mouthfeel_final_notes', v)} />
                </div>
            </div>
        </div>
    );
};

const OverallSection = ({ data, onChange }) => {
    const updateDesc = (k, v) => onChange(prev => ({ ...prev, descriptive: { ...prev.descriptive, [k]: v } }));
    const updateAff = (k, v) => onChange(prev => ({ ...prev, affective: { ...prev.affective, [k]: v } }));
    const defectsList = ['Moldy', 'Potato', 'Phenolic'];

    return (
        <div className="space-y-6 mt-2">
             <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3">Extrinsic / Overall</h3>
                 <TextAreaControl label="Overall Impression" placeholder="General notes..." value={data.descriptive.part3_notes} onChange={v => updateDesc('part3_notes', v)} />
            </div>
            
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 className="text-sm font-bold text-blue-800 uppercase mb-3">Affective Score</h3>
                <SliderControl label="Overall Score" value={data.affective.overall_final} onChange={v => updateAff('overall_final', v)} min={1} max={9} />
                 <div className="mt-4">
                    <TextAreaControl placeholder="Notes..." value={data.affective.overall_final_notes} onChange={v => updateAff('overall_final_notes', v)} />
                </div>

                {/* Defects Block */}
                <div className="mt-6 border-t border-blue-200 pt-4">
                    <h4 className="text-xs font-bold text-red-700 uppercase mb-2">Defects</h4>
                    
                    <div className="mb-3">
                        <label className="text-xs font-medium text-gray-600 block mb-1">Non-Uniform Cups (x2 pts)</label>
                        <div className="flex space-x-1">
                            {[1,2,3,4,5].map(n => (
                                <button key={n} onClick={() => updateAff('non_uniform_cups', data.affective.non_uniform_cups === n ? n-1 : n)}
                                    className={`w-6 h-6 rounded border ${n <= data.affective.non_uniform_cups ? 'bg-red-500 border-red-600' : 'bg-white border-gray-300'}`}
                                />
                            ))}
                        </div>
                    </div>

                    <div className="mb-3">
                        <label className="text-xs font-medium text-gray-600 block mb-1">Defective Cups (x4 pts)</label>
                         <div className="flex space-x-1">
                            {[1,2,3,4,5].map(n => (
                                <button key={n} onClick={() => updateAff('defective_cups', data.affective.defective_cups === n ? n-1 : n)}
                                    className={`w-6 h-6 rounded border ${n <= data.affective.defective_cups ? 'bg-red-800 border-red-900' : 'bg-white border-gray-300'}`}
                                />
                            ))}
                        </div>
                    </div>

                    <div>
                        <label className="text-xs font-medium text-gray-600 block mb-1">Defect Type</label>
                        <div className="flex space-x-3">
                            {defectsList.map(d => (
                                <label key={d} className="flex items-center space-x-1 text-xs">
                                    <input type="checkbox" checked={data.affective.defects.includes(d)}
                                        onChange={e => {
                                            const curr = data.affective.defects;
                                            const next = e.target.checked ? [...curr, d] : curr.filter(x => x !== d);
                                            updateAff('defects', next);
                                        }}
                                        className="text-red-600"
                                    />
                                    <span>{d}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

const AromaModal = ({ isOpen, onClose, onSelect, initialCategory }) => {
    if (!isOpen) return null;
    
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] overflow-hidden">
                <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 className="font-bold text-lg text-gray-800">Selector de Aromas</h3>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200 transition-colors">
                        <X size={24} className="text-gray-600" />
                    </button>
                </div>
                
                <div className="flex-1 overflow-hidden relative bg-gray-50">
                    <InteractiveWheel 
                        onSelect={onSelect} 
                        onCancel={onClose} 
                    />
                </div>
            </div>
        </div>
    );
};


// --- MAIN APP COMPONENT ---

export default function App() {
  // Initialize with one session
  const [sessions, setSessions] = useState([
      { id: 'init-1', data: getFreshState() }
  ]);
  const [activeSessionId, setActiveSessionId] = useState('init-1');

  const [isExporting, setIsExporting] = useState(false);
  
  // Modal State
  const [modalState, setModalState] = useState({ isOpen: false, listKey: null });

  const containerRef = useRef(null);

  // Helper to get active session object
  const activeSession = useMemo(() => 
    sessions.find(s => s.id === activeSessionId) || sessions[0], 
  [sessions, activeSessionId]);

  const activeData = activeSession.data;

  // Calculated Scores for ACTIVE session
  const scores = useMemo(() => {
    let attributeScore = 0;
    const affective = activeData.affective;
    const keys = [
        'fragrance_final', 'aroma_final', 'flavor_final', 'aftertaste_final',
        'acidity_final', 'sweetness_final', 'mouthfeel_final', 'overall_final'
    ];

    keys.forEach(k => {
        const val = affective[k];
        if (typeof val === 'number') {
            attributeScore += SLIDER_POINTS[String(val)] || 0;
        }
    });

    const defectPoints = (affective.non_uniform_cups * 2) + (affective.defective_cups * 4);
    const totalScore = 58.00 + attributeScore - defectPoints;

    return {
        attribute: attributeScore.toFixed(2),
        defects: defectPoints.toFixed(2),
        total: totalScore.toFixed(2)
    };
  }, [activeData.affective]);

  // --- Session Management Handlers ---

  const handleAddSession = () => {
      const newId = `session-${Date.now()}`;
      const newState = getFreshState();
      
      // Smart Copy: Copy metadata (Name, Date) from the currently active session
      if (activeData) {
          newState.metadata.nombre = activeData.metadata.nombre;
          newState.metadata.fecha = activeData.metadata.fecha;
      }

      setSessions(prev => [...prev, { id: newId, data: newState }]);
      setActiveSessionId(newId);
      
      if (containerRef.current) containerRef.current.scrollTop = 0;
  };

  const handleRemoveSession = (e, idToRemove) => {
      e.stopPropagation(); 
      
      if (sessions.length <= 1) return; 

      const indexToRemove = sessions.findIndex(s => s.id === idToRemove);
      const newSessions = sessions.filter(s => s.id !== idToRemove);
      
      setSessions(newSessions);

      if (idToRemove === activeSessionId) {
          const newIndex = Math.max(0, indexToRemove - 1);
          setActiveSessionId(newSessions[newIndex].id);
      }
  };

  const handleUpdateActiveSession = (updater) => {
      setSessions(prevSessions => {
          return prevSessions.map(session => {
              if (session.id === activeSessionId) {
                  // Check if updater is function or value
                  const newData = typeof updater === 'function' ? updater(session.data) : updater;
                  return { ...session, data: newData };
              }
              return session;
          });
      });
  };

  // --- Feature Handlers ---

  const handleOpenAromaModal = (listKey) => {
      if (activeData.descriptive[listKey].length >= 5) {
          alert("Has seleccionado el límite de 5 descriptores.");
          return;
      }
      setModalState({ isOpen: true, listKey });
  };

  const handleAromaSelect = (text, category) => {
      const key = modalState.listKey;
      if (key) {
          handleUpdateActiveSession(prev => ({
              ...prev,
              descriptive: {
                  ...prev.descriptive,
                  [key]: [...prev.descriptive[key], { text, category }]
              }
          }));
      }
      setModalState(prev => ({ ...prev, isOpen: false }));
  };

  const handleExport = () => {
      generatePDF(activeData, containerRef, setIsExporting);
  };

  return (
    <div className="flex flex-col h-screen bg-gray-100 font-sans text-gray-800">
        <header className="bg-blue-800 text-white shadow-md z-10 shrink-0 relative">
            <div className="p-4 pb-2">
                <h1 className="text-xl font-bold text-center">SCA Coffee Value Assessment</h1>
            </div>
            
            {/* Tabs Container */}
            <div className="flex items-end px-2 space-x-1 overflow-x-auto no-scrollbar">
                {sessions.map((session, index) => {
                    const isActive = session.id === activeSessionId;
                    const label = session.data.metadata.cafe.trim() || `Muestra ${index + 1}`;
                    
                    return (
                        <div 
                            key={session.id}
                            onClick={() => setActiveSessionId(session.id)}
                            className={`
                                group relative flex items-center min-w-[120px] max-w-[200px] py-2 px-3 rounded-t-lg cursor-pointer transition-all duration-200 select-none
                                ${isActive 
                                    ? 'bg-gray-100 text-blue-900 font-bold shadow-[0_-2px_5px_rgba(0,0,0,0.1)] z-10' 
                                    : 'bg-blue-900/40 text-blue-100 hover:bg-blue-900/60'
                                }
                            `}
                            style={{ marginBottom: isActive ? '-1px' : '0' }}
                        >
                            <span className="truncate mr-6 text-sm">{label}</span>
                            
                            {sessions.length > 1 && (
                                <button 
                                    onClick={(e) => handleRemoveSession(e, session.id)}
                                    className={`absolute right-1 top-1/2 -translate-y-1/2 p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors ${isActive ? 'text-gray-400' : 'text-blue-300'}`}
                                >
                                    <X size={12} />
                                </button>
                            )}
                        </div>
                    );
                })}
                
                <button 
                    onClick={handleAddSession}
                    className="mb-1 p-1.5 rounded-full bg-blue-700 text-blue-100 hover:bg-blue-600 hover:text-white transition-colors ml-1 shrink-0"
                    title="Add new sample"
                >
                    <Plus size={18} />
                </button>
            </div>
        </header>

        <main ref={containerRef} className="flex-1 overflow-y-auto p-4 space-y-3 pb-32 md:pb-24 bg-gray-100">
            <AccordionItem title="Información de la Cata" defaultOpen>
                <MetadataSection data={activeData} onChange={handleUpdateActiveSession} />
            </AccordionItem>
            
            <AccordionItem title="1. Fragancia y Aroma">
                <FragranceSection data={activeData} onChange={handleUpdateActiveSession} openAromaModal={handleOpenAromaModal} />
            </AccordionItem>
            
            <AccordionItem title="2. Sabor y Postgusto">
                <FlavorSection data={activeData} onChange={handleUpdateActiveSession} openAromaModal={handleOpenAromaModal} />
            </AccordionItem>
            
            <AccordionItem title="3. Acidez">
                <AciditySection data={activeData} onChange={handleUpdateActiveSession} />
            </AccordionItem>
            
            <AccordionItem title="4. Dulzura">
                <SweetnessSection data={activeData} onChange={handleUpdateActiveSession} />
            </AccordionItem>
            
            <AccordionItem title="5. Cuerpo (Mouthfeel)">
                <MouthfeelSection data={activeData} onChange={handleUpdateActiveSession} />
            </AccordionItem>
            
            <AccordionItem title="6. General y Defectos">
                <OverallSection data={activeData} onChange={handleUpdateActiveSession} />
            </AccordionItem>

            {/* Export Button Area */}
            <div className="p-6 bg-white rounded-lg shadow text-center mt-6 border border-gray-200">
                <h3 className="text-lg font-bold text-gray-800 mb-2">Exportar Muestra Actual</h3>
                <p className="text-gray-500 mb-4 text-sm">Generar reporte PDF para <strong>{activeData.metadata.cafe || "esta muestra"}</strong>.</p>
                <button 
                    onClick={handleExport} 
                    disabled={isExporting}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                >
                    {isExporting ? <Loader2 className="animate-spin" /> : <FileDown />}
                    <span>{isExporting ? 'Generando PDF...' : 'Exportar a PDF'}</span>
                </button>
            </div>
        </main>

        {/* Score Footer */}
        <footer className="p-4 bg-blue-900 text-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] grid grid-cols-3 gap-2 z-20 shrink-0">
            <div className="text-center">
                <span className="text-xs font-medium text-blue-200 block uppercase tracking-wider">Atributos</span>
                <span className="text-xl font-bold font-mono">{scores.attribute}</span>
            </div>
            <div className="text-center border-l border-blue-700">
                <span className="text-xs font-medium text-blue-200 block uppercase tracking-wider">Defectos</span>
                <span className="text-xl font-bold text-red-300 font-mono">-{scores.defects}</span>
            </div>
            <div className="text-center border-l border-blue-700 bg-blue-800 rounded-lg mx-1">
                <span className="text-xs font-medium text-blue-200 block uppercase tracking-wider mt-1">Total</span>
                <span className="text-2xl font-extrabold text-white font-mono">{scores.total}</span>
            </div>
        </footer>

        <AromaModal 
            isOpen={modalState.isOpen} 
            onClose={() => setModalState({ ...modalState, isOpen: false })}
            onSelect={handleAromaSelect}
        />
    </div>
  );
}
